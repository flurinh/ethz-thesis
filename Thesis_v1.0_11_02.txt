DISS. ETH NO






Predicting Opsin Spectral Properties 
Across Protein Folds






A thesis submitted to attain the degree of
DOCTOR OF SCIENCES
(Dr. sc. ETH Zurich)








presented by








FLURIN, STEFAN HIDBER








born on 10.08.1994








accepted on the recommendation of 


Prof. Dr. Volodymyr Korkhov (examiner)
Dr. Xavier Deupi (co-examiner)
Prof. Dr. Peter Matthias (co-examiner)
Prof. Dr. Hideaki Kato (co-examiner)








2026
________________


Acknowledgements
________________
Table of content
________________
Glossary
________________
Summary
________________
Introduction
A Brief History of Protein Structures


For most of history, proteins were invisible. Biochemists knew they existed, knew they catalyzed reactions and transmitted signals, but could not see them. X-ray crystallography changed this. In 1958, John Kendrew solved the structure of myoglobin [@kendrew1958]. For the first time, researchers could see how a protein folded, a chain of amino acids wrapped into a compact globule, with a heme group nestled in a hydrophobic pocket where oxygen binds. The structure revealed why myoglobin worked. Myoglobin is a soluble protein, floating freely in the cytoplasm. 


Membrane proteins proved far harder. These proteins (channels, pumps, and receptors embedded in cell membranes) have hydrophobic surfaces that contact lipids and also hydrophilic surfaces exposed to water on the intra- or extracellular side of the membrane. Removed from the membrane, they aggregate and aggregated proteins cannot form the ordered crystals that X-ray crystallography requires. Alas, membrane protein structures remained out of reach for decades. Yet these proteins handle many interactions between a cell and its environment, making them essential targets for understanding biology.


Despite these challenges, the first view of a membrane protein came in 1975. Richard Henderson and Nigel Unwin used electron microscopy to image bacteriorhodopsin, a light-driven proton pump from Halobacterium salinarum [@henderson1975]. The resolution was 7 Å, too coarse to resolve individual atoms, but the map showed seven rod-like densities spanning the membrane. Bacteriorhodopsin was built from seven transmembrane helices. Bacteriorhodopsin is a microbial protein, but the seven-helix architecture also appeared in an important class of animal membrane proteins. 


In 1993, Gebhard F.X. Schertler, Claudio Villa, and Richard Henderson published a projection map of bovine rhodopsin, the light-sensitive protein of vertebrate eyes and the first GPCR amenable to structural analysis [@schertler1993]. GPCRs -G protein coupled receptors- got their names from their effector proteins, the G proteins. The GPCR activates the G proteins inside the cell which leads to a signalling cascade. In the case of bovine rhodopsin, a single photon can lead to a structural change in the bovine rhodopsin starting that cascade - a very effective approach cells have to amplify tiny signals into large cellular responses. Back to their first projection map: The 9 Å map showed that rhodopsin, like bacteriorhodopsin, contained seven transmembrane helices. 


Then in 2000, Krzysztof Palczewski solved bovine rhodopsin at 2.8 Å, the first GPCR at atomic resolution [@palczewski2000], confirming the seven-helix architecture. This high resolution revealed how the retinal, the light-absorbing chromophore, sits in the transmembrane core. 


Later in 2007, Brian Kobilka's group solved the β₂-adrenergic receptor [@rasmussen2007], showing that other GPCRs could be crystallized. Kobilka shared the 2012 Nobel Prize with Robert Lefkowitz for their work.


Crystallography requires proteins to form ordered crystals, a barrier that excludes many membrane proteins. Cryo-electron microscopy, another method to elucidate protein structures, led to many more structures being solved. The technique flash-freezes proteins in thin ice, preserving their conformations, but for decades cryo-EM produced only blurry images, useful for overall shape but not atomic detail. The breakthrough came around 2013 with direct electron detectors, which dramatically improved signal quality, and new algorithms that could align and average millions of particle images. Resolution improved from 10-20 Å to 3 Å. Even protein complexes that would not crystallize (large, flexible, or transient assemblies) could be imaged. Henderson shared the 2017 Nobel Prize in Chemistry with Jacques Dubochet and Joachim Frank for this work.


Together these two methods shaped structural biology. The largest experimental database for protein structures, the Protein Data Bank grew rapidly, from roughly 1,000 structures in 1993 to over 200,000 by 2024, with GPCR structures alone rising from fewer than 5 in 2007 to over 700 today.


Structure determination investigates one protein at a time. Sequencing opened a window onto the full diversity of the protein world. Sanger sequencing gave way to genomics, then metagenomics, the sequencing of DNA extracted directly from environmental samples. UniProt now contains over 200 million protein sequences, many from ocean surveys, soil samples, and gut microbiomes. For some protein families, metagenomics revealed unexpected abundance. Microbial rhodopsins are a great example. What had seemed a peculiar protein of archaea turned out to be abundant everywhere.[a] Discovered in 2000 from Pacific Ocean samples [@beja2000], they are now recognized as among the most abundant proteins on Earth, and metagenomics has revealed thousands of rhodopsin sequences across bacteria, archaea, algae, and fungi.
Unsurprisingly, sequence diversity far exceeds structural coverage using experimental methods. In 2020, DeepMind's AlphaFold2 took first place in the annual protein structure prediction competition, demonstrating that protein structures could be predicted from sequence - with a huge leap in accuracy [@jumper2021]. Within two years, DeepMind and EMBL-EBI released predicted structures for over 200 million proteins[@varadi2022]. And structure prediction continues to advance. New systems like Boltz [@wohlwend2024] now predict proteins bound to their ligands—small molecules, cofactors, and interaction partners—enabling computational analysis of binding pockets without requiring experimental structures of each complex.
Alongside structure prediction,  other deep learning methodologies such as protein language models have transformed how researchers extract information from amino acid sequences. These models train on millions of protein sequences, learning statistical patterns that reflect evolutionary constraints and structural relationships. Models like ESM-2 and Ankh produce embeddings—dense numerical vectors for each amino acid in a sequence. A 300-residue protein yields 300 vectors, each capturing what the model has learned about that residue in its sequence context. Averaging these vectors across the sequence produces a single representation of the entire protein. Two proteins with diverged sequences but similar functions often have similar embeddings, even when their sequences share less than 20% identity. This property makes embeddings valuable as input features for machine learning models that predict protein properties.
With these advances, the field saw an explosion in data abundance, and every known protein sequence now has a readily available predicted structure.


Yet predicted structures lack context. AlphaFold predictions come with confidence scores and little else, lacking experimental conditions or functional annotations. Comparing predictions to experimental structures requires careful handling of coordinate systems and numbering conventions. Annotating hundreds or tens of thousands of structures needs automation. The bottleneck has shifted from generating data to understanding it. For researchers studying membrane protein families like GPCRs and microbial rhodopsins, this shift has practical consequences. These families now have hundreds of structures and are targets for drug discovery and biotechnology, yet systematic studies across their members remains difficult.


Studying Proteins


Understanding protein function requires more than accumulating structures; it requires comparing them. Data abundance enables diverse approaches to this challenge. For protein superfamilies -large, evolutionarily related groups sharing a common fold- one particularly powerful approach is systematic comparison across members. Hundreds of related proteins, each with slightly different sequences and functions, create natural experiments. Examining which residues vary and which are conserved reveals the molecular basis of functional differences.


Such comparison requires knowing which positions are equivalent — position 85 in one protein may correspond to position 113 in another. For closely related proteins, sequence alignment resolves this, but superfamily members can share less than 20% sequence identity, too little for reliable alignment. Structure-based approaches are more robust but require solved structures for both proteins. For GPCRs researchers tackled this problem in 1995. Ballesteros and Weinstein introduced a numbering system that assigns each position a two-part identifier consisting of the helix number and position relative to the most conserved residue on that helix [@ballesteros1995]. The format is X.50 for the reference residue on helix X, with other positions numbered relative to this anchor. Position 3.32 indicates helix 3, at the position numbered 32 (eighteen residues before the reference position 50). This scheme translates across the entire GPCR superfamily, roughly 800 members in the human genome. Scientists adopted the numbering system broadly, and GPCRdb built on this foundation [@kooistra2021]. This database integrates sequences, structures, ligands, and mutations using Ballesteros-Weinstein positions as the common coordinate system, enabling queries such as identifying the residue at position 3.32 across all aminergic receptors within seconds.


This numbering system shaped how an entire field communicates. When a researcher reports that a mutation at position 3.32 affects ligand binding, every GPCR researcher immediately understands where that position is and can relate the finding to their own work. With standardized positions, binding sites can be compared across receptors directly. If a drug binds at position 3.32 in one receptor, researchers can immediately ask what residue sits at 3.32 in related receptors and whether side effects might arise from off-target binding. Functional insights accumulate across laboratories because everyone uses the same coordinate system. The scheme works because GPCRs share a conserved seven-transmembrane fold — the helical architecture is stable enough across the superfamily that helix-relative numbering remains meaningful even between distantly related members. The GPCR field illustrates what a common coordinate system enables. This thesis examines also another seven-transmembrane protein family where such standardization did not exist.


Opsins


This thesis studies opsins. They are a family of seven-transmembrane proteins that become light-sensitive upon binding retinal as their chromophore. They exist across all domains of life (archaea, bacteria, algae, fungi, and animals) where they perform diverse functions including pumping ions, opening channels, sensing light direction, and activating signaling cascades.
Opsins bind retinal, a vitamin A derivative, through a covalent Schiff base linkage to a conserved lysine residue — a bond formed between retinal's aldehyde group and the lysine's amino group. Strictly, opsin refers to the apoprotein alone, while rhodopsin refers to the protein with retinal bound; in practice, the terms are used interchangeably[b]. When light hits the retinal, it isomerizes, triggering a conformational change in the protein that serves as the signal. The protein environment around the retinal tunes which wavelengths of light are absorbed. All opsins share the same basic mechanism: retinal isomerization coupled to conformational change.
Despite sharing a chromophore, opsins fall into two evolutionarily completely distinct families. 


Type I opsins, the microbial rhodopsins, are found in archaea, bacteria, algae, and fungi. These are not GPCRs and share no sequence homology with type II (animal opsins), adopting a distinct fold despite sharing a seven-transmembrane helix architecture. Retinal usually binds in the all-trans configuration, and light triggers isomerization to 13-cis. The protein responds directly by pumping ions, opening a channel, or activating an enzymatic domain, with no G protein involved. The founding member[c] is bacteriorhodopsin, discovered in 1971 in Halobacterium salinarum [@oesterhelt1971], which pumps protons across the membrane. The family has since expanded to include ion pumps with different specificities, light-gated channels, sensory receptors, and light-activated enzymes. Channelrhodopsins, which open cation channels in response to light, enabled optogenetics—the use of light to control genetically targeted cells—and transformed neuroscience [@nagel2003]. Despite this functional diversity, all Type I opsins share the same architecture.


Type II opsins are GPCRs found in animals[d]. Retinal binds in the 11-cis configuration, and light triggers isomerization to all-trans. The conformational change activates a bound G protein, initiating a signaling cascade; the protein itself does not pump ions or open channels. The founding member is bovine rhodopsin, the photoreceptor in rod cells that enables dim-light vision. Cone opsins, which mediate color vision, are closely related and exist in multiple spectral variants. The spectral tuning of these opsins determines which wavelengths each type detects.


Type I and Type II opsins are not homologous. They share no detectable sequence similarity, and their seven-transmembrane folds are structurally distinct. These two families represent nature evolving the same function -light sensitive proteins using retinal as a ligand- in analogous structures, not homologous ones. Two separate protein lineages faced the same problem of detecting light and arrived at the same solution, binding retinal via a protonated Schiff base (one that carries a positive charge) and using light-triggered isomerization to drive conformational change.[e]


This shared solution has an important consequence. Both families use the same chromophore in geometrically similar binding pockets. In bacteriorhodopsin, retinal binds to lysine 216 (K216) on helix G, while in bovine rhodopsin, retinal binds to lysine 296 (K296) on helix VII. In both cases, the chromophore sits in a pocket formed by transmembrane helices, the Schiff base is protonated, and a negatively charged residue (aspartate or glutamate, called the counterion) sits nearby to stabilize the positive charge (Figure 1.1). Despite independent origins, both families converged on shared geometry because that geometry solves a physical problem, namely tuning retinal's electronic properties to absorb light at specific wavelengths.


[FIGURE 1.1: Structural comparison of Type I and Type II opsins. (A) Bacteriorhodopsin (PDB: 1C3W), a microbial rhodopsin (Type I), shown in transparent cartoon with the retinal chromophore (rust) and 
  Schiff base lysine K216 (green). (B) Bovine rhodopsin (PDB: 1U19), an animal opsin (Type II/GPCR), shown in the same style. (C,D) Binding pocket close-ups for bacteriorhodopsin and bovine rhodopsin,
  respectively, showing all residues within 6 Å of retinal as gray sticks.]


If local environment determines function, and both families have similar local environments, then functional principles might transfer across families. This premise enables cross-family analysis. The spectral properties of an opsin, meaning the wavelengths of light it absorbs, depend on the residues surrounding the chromophore, and if those residues occupy similar positions in both families, the rules governing spectral tuning might be shared.


Such analysis requires consistent positional annotation, knowing which residues in one protein correspond to which in another. Type II opsins, as GPCRs, benefit from the Ballesteros-Weinstein numbering system described in the previous section, and researchers can compare binding pocket residues across animal opsins using standardized positions. Not for lack of trying. Early efforts used bacteriorhodopsin as a reference, numbering positions in other proteins by their alignment to bR. But microbial rhodopsins are so diverse that sequence similarity between distant members is too low for reliable alignment. A more recent approach defined positions based on conserved hydrogen bond networks, but these networks differ between functional classes — what holds for bacteriorhodopsin does not generalize to halorhodopsins, channelrhodopsins, or enzyme rhodopsins. The problem remains unsolved.


Spectral Tuning


Every opsin has a characteristic absorption spectrum, and the peak of that spectrum, the wavelength at which the protein absorbs light most strongly, is called λmax. This parameter determines what color of light activates the opsin. An opsin with λmax at 480 nm responds best to blue light, one at 560 nm responds to green, and one at 620 nm responds to red. Across the opsin superfamily, λmax ranges from approximately 350 nm (ultraviolet) to 650 nm (far-red), a span of 300 nm achieved using the same chromophore (Figure 1.2).


[FIGURE 1.2: Charge distribution along the retinal chromophore. The retinal of bovine rhodopsin (PDB: 1U19) shown as sticks within a transparent Gaussian surface envelope, colored by a point-charge    
  gradient from the protonated Schiff base nitrogen (red, positive) to the β-ionone ring (blue, neutral). Positive charge density decreases along the conjugated polyene chain, and binding pocket        
  residues modulate this distribution — shifting the energy gap for light absorption and thus determining λ_max.]


Spectral properties matter for applications. In optogenetics, controlling which wavelengths activate an opsin enables precise manipulation. Red-shifted opsins (λmax > 600 nm) allow deeper tissue penetration because red light travels further through tissue than blue. Blue-shifted opsins (λmax < 450 nm) enable spectral separation[f], allowing multiple opsins with different λmax values to be activated independently in the same tissue. Engineering opsins with specific spectral properties requires understanding the molecular basis of what determines λmax.


The chromophore itself provides only part of the answer. Retinal in solution absorbs at approximately 380 nm, near ultraviolet light, yet when bound to different opsins, absorption can shift by over 200 nm, ranging from below 350 nm to over 600 nm. The protein environment tunes the chromophore, and understanding how evolution achieves over 250 nm of spectral range using a single chromophore requires examining the local environment around the retinal.
Retinal is a polyene, a chain of alternating single and double bonds. The electrons in these double bonds are delocalized across the chain, forming a π-electron system. Light absorption promotes an electron from a lower-energy state to a higher-energy state. The energy gap between these states determines the wavelength of light absorbed. A smaller gap means lower energy, which corresponds to longer wavelengths (red shift). A larger gap means higher energy, which corresponds to shorter wavelengths (blue shift).
In opsins, retinal attaches to the protein through a Schiff base linkage to a conserved lysine (e.g., K296 in bovine rhodopsin, K216 in bacteriorhodopsin). In most opsins, this Schiff base is protonated, meaning it carries a positive charge. The protonation state is critical: protonated opsins absorb in the visible range (above 400 nm), while deprotonated opsins absorb in the ultraviolet (below 400 nm), as seen in UV-sensitive SWS1 cone opsins. The protonated Schiff base creates a positive charge in the binding pocket. How the protein environment stabilizes this charge affects the distribution of electron density across the retinal's conjugated system, altering the energy gap between ground and excited states and thereby determining λmax.
In many opsins, a negatively charged residue (aspartate or glutamate) sits near the protonated Schiff base and stabilizes the positive charge. This residue is called the counterion. In bacteriorhodopsin, the counterion is D85. In bovine rhodopsin, it is E113. A counterion that stabilizes the positive charge more strongly localizes it near the Schiff base. This increases the energy gap and shifts absorption to shorter wavelengths (blue shift). Conversely, a counterion allowing the positive charge to delocalize along the polyene chain decreases the energy gap and shifts absorption to longer wavelengths (red shift).


Other residues in the binding pocket contribute too. Polar and charged residues shape the electrostatic environment through hydrogen bonds, local dipoles, and long-range Coulombic interactions. Aromatic residues influence retinal through both steric constraints and dispersive interactions with its π-system. The cumulative effect of all these interactions determines λmax.


Single mutations at key positions can produce large spectral shifts. The D85N mutation in bacteriorhodopsin replaces the negatively charged aspartate counterion with a neutral asparagine, producing a red shift of up to 40 nm. The equivalent mutation in bovine rhodopsin, E113Q, produces a similar effect. The counterion is a major determinant of λmax, though not the only one; other binding pocket residues contribute individual shifts of 10-30 nm.


These examples illustrate that understanding spectral tuning requires identifying which residues matter and why, but also how they vary across proteins. Studying this systematically requires comparing binding pocket residues, which returns to the standardization problem identified in the previous section. Beyond comparison, researchers seek prediction. The ability to predict λmax from sequence alone would enable rapid screening of metagenomic discoveries and guide engineering efforts. Family-specific methods exist for this purpose. OPTICS [@frazer2025] predicts λmax for type II opsins using sequence features and phylogenetic information trained on the VPOD dataset [@davis2024], achieving approximately 5.5 nm mean absolute error, but working only within the GPCR family. For microbial opsins, Inoue et al. [@inoue2021] developed a LASSO regression model using binding pocket residue identities, achieving 7.8 nm MAE on their test set. RhoMax [@gerstenbruch2024], the most recent approach, uses a graph neural network on type I opsin binding pocket structures to achieve 6.8 nm MAE. 


These methods are family-specific by construction. OPTICS and Inoue et al. both rely on multiple sequence alignments within their respective families, using each alignment position as a regression feature — an approach that depends on reliable alignment and therefore cannot extend across families. RhoMax sidesteps alignment by operating on structures directly but requires a solved or predicted structure for every query protein and was trained exclusively on Type I data.
Existing tools can predict λmax within a family but not across families, and each depends on infrastructure — reliable alignments or available structures — that is family-specific. Yet the underlying question is not family-specific. If spectral properties are determined by the local environment around the retinal, then the relevant unit of analysis is not "a Type I opsin" or "a Type II opsin" but a retinal binding pocket. Given any retinal binding pocket, regardless of which protein scaffold surrounds it, what are its spectral properties? Framed this way, the Type I / Type II distinction becomes irrelevant to the prediction problem — what matters is the geometry and chemistry of the pocket itself. Two research questions follow.
First, how can standardized positions be established across microbial rhodopsins? The systematic comparison that enabled GPCR research requires a common coordinate system. Microbial rhodopsins need the same.
Second, can a retinal binding pocket alone predict spectral properties? If the local chromophore environment determines λmax, a model should be able to take any retinal binding pocket as input and predict absorption — regardless of whether that pocket belongs to a proton pump, a channel, or an animal photoreceptor. 
Addressing both questions requires capabilities that current tools do not provide, specifically linking sequences, structures, and functional properties across databases while maintaining consistent positional annotation.


Fragmentation in Bioinformatics


Answering these questions requires combining protein sequences from UniProt, structures from the PDB and AlphaFold DB, measured λmax values from the literature, embeddings from protein language models, and annotations such as binding pocket definitions. No single database contains all of this. Researchers must gather data from multiple sources, convert between formats, and track which identifiers refer to the same protein — UniProt calls it P02945, the PDB calls the structure 1C3W, and AlphaFold calls its prediction AF-P02945-F1.
Tools exist for individual tasks. Biopython handles sequence retrieval and alignment, dedicated suites like the Schrödinger platform provide structure analysis and molecular modeling, and protein language models produce embeddings through their own pipelines. But these tools were not designed to work together. A typical analysis — comparing spectral properties across 100 microbial rhodopsins — requires downloading sequences, fetching structures or predictions, collecting λmax values from the literature, aligning sequences, mapping sequence positions to structural coordinates, extracting binding pocket residues, and correlating those features with absorption. Each step uses a different tool and a different format. The glue code connecting them dominates the work and gets rewritten for each project.
This fragmentation limits both communities that study opsins. Experimentalists who measure λmax values cannot easily compare them to structural features without programming expertise. Bioinformaticians can perform the analysis but spend disproportionate effort on data engineering that contributes nothing to scientific insight. The barrier is tooling, not ideas.
Establishing standardized positions across microbial rhodopsins requires assembling and aligning structures from multiple sources. Testing whether a retinal binding pocket alone predicts spectral properties requires linking thousands of sequences to their λmax values, embeddings, and structural features. These are not extraordinary requirements, but no existing framework addresses them.


Thesis Contributions


Microbial rhodopsins lack the standardized positional annotation that enabled systematic GPCR comparison. No method predicts spectral properties from a retinal binding pocket regardless of which protein family it belongs to. And existing tools do not compose into workflows that link sequences, structures, and functional properties while maintaining consistent identity. This thesis addresses all three through an integrated system.


ProtOS provides the data infrastructure that underlies the other contributions. Protein research requires linking sequences, structures, functional properties, and computational representations across databases that use different identifiers, formats, and conventions. ProtOS manages these relationships through a processor architecture that handles specific data types (sequences, structures, embeddings, properties, residue annotations) through a consistent interface. The framework enables workflows that span data modalities without the glue code that currently dominates computational protein analysis. ProtOS-MCP extends this through the Model Context Protocol, enabling natural language access to protein data operations—an experimentalist can ask which residues contact retinal and receive an answer without writing code.


MOGRN (Microbial Opsin Generic Residue Numbering) establishes standardized positional annotation for microbial rhodopsins. Overall sequence identity across major classes falls below 15%, yet the retinal-binding pocket geometry remains conserved. MOGRN introduces a structure-based numbering system anchored to the conserved retinal-binding site, following the Ballesteros-Weinstein convention used for GPCRs. The Schiff base lysine becomes position 7.50 by definition; other positions are numbered relative to helix-specific anchors. Validated against 129 structures spanning the functional diversity of microbial rhodopsins, the system provides a common coordinate system that enables systematic comparison across the superfamily.


LAMBDA (Light Absorption Modeling through Binding Domain Analysis) tests whether shared binding pocket geometry enables cross-family learning for spectral prediction. Existing methods work within single opsin families but do not transfer across the type I / type II divide. LAMBDA represents binding pockets as graphs, enabling a single model to learn spectral property prediction for any retinal binding protein. I also show that LAMBDA works with only protein sequence inputs if there is a standardized positional annotation: MOGRN for type I, Ballesteros-Weinstein for type II. Trained on 2,120[g] sequences spanning both opsin families and hCRBPII (a lipocalin fold), LAMBDA achieves state-of-the-art accuracy: 5.18 nm mean absolute error on type II opsins and 6.86 nm on type I, while providing cross-family capability that existing methods lack. I used ProtOS to create a comprehensive dataset of sequences containing over 47,700 sequences, that I named the Opsin Atlas. I predicted the spectral properties for all its members, enabling systematic identification of candidates with desired spectral properties.


These contributions integrate into a system. ProtOS manages the data that MOGRN annotates and LAMBDA consumes. The Opsin Atlas exists because ProtOS could route 47,700 sequences through GRN annotation and spectral prediction. The following chapters present each contribution in detail, beginning with ProtOS.


ProtOS
ProtOS was not planned. Over three years of research, I accumulated scripts for parsing structures, fetching sequences, reconciling identifiers, and extracting binding pocket features. The same problems appeared in every analysis, solved each time with slightly different code. The majority of my time went not to data management — parsing inconsistent file formats, reconciling identifiers across databases, and writing disposable scripts to connect tools that were never designed to work together. Biological data files are messy in ways that the word "data" does not convey. Structures for example come as e.g., .pdb, .cif, .pdbqt, or .sdf — all human-readable text formats designed for a researcher inspecting one structure at a time, not for programmatic analysis across thousands of proteins. Annotations are often inconsistent between databases. Metadata written by researchers can be unreliable. I gathered everything into one package, generalized the interfaces, and ensured the pieces worked together. What started as manual data curation became the foundation on which every subsequent contribution in this thesis ultimately relies— and, through a natural language interface described in Chapter 6, a tool that makes protein data accessible to researchers who cannot write code.
The underlying problem is not unique to this thesis. Understanding what determines an opsin's spectral properties requires more than one kind of data. Sequence comparison reveals which residues evolution has conserved — but global sequence similarity is a poor predictor of λmax, because absorption depends on the local environment of the binding pocket, not the full chain. Structure shows where binding pocket residues sit relative to the chromophore — but of the thousands of known opsin sequences, fewer than 70 have unique experimental structures. A measured λmax tells you how a protein absorbs light — but the measurement sits in a paper, disconnected from the sequence in UniProt and the structure in the PDB. No single data type answers the question of what determines spectral tuning. Answering it requires integrating all three — and doing so across thousands of proteins.
The practical barrier is that these data types live apart. Sequences in UniProt, structures in the PDB, predictions in AlphaFold DB, measurements scattered across decades of publications. Bacteriorhodopsin alone carries three identifiers — P02945 (uniprot), 1C3W (pdb id), AF-P02945-F1 (alphafolddb)— one per database, none linking to the others[h]. Tools like Biopython or the Schrödinger suite handle tasks dealing with a single protein well, but chaining them into reproducible multi-modal workflows means writing custom scripts that parse, convert, and reconcile at every step.
ProtOS is a Python package built around a single organizing principle: all protein data lives under one path. Setting the ProtOS path defines a strict directory structure — sequences, structures, embeddings, properties, each in a predictable location — with no configuration required. A protein added to ProtOS exists in one place, and every processor knows where to find it. Every data object — a sequence, a structure, an embedding, a measured property — enters the system as an entity: a named record with tracked identity that persists across sessions. A structure loaded from the PDB, a sequence fetched from UniProt, and a λmax value entered from a paper all attach to the same protein and stay attached as analysis proceeds. Six processors handle the data types this work requires: sequences, structures, residue contact graphs, standardized positions, embeddings, and properties. Each manages one modality. Outputs from one become inputs to another — through recorded relationships, not file naming conventions or researcher memory (Figure 2.1).
*![Figure 2.1: ProtOS architecture overview. (A) ProtosPath and the Entity/Registry/Dataset system provide persistent identity and organization. (B) Processors handle specific data modalities: GRN Processor for standardized positions, Sequence Processor for FASTA and alignments, Structure Processor for coordinates, Embedding Processor for pLM representations, Graph Processor for contact networks, and Property Processor for tabular data. (C) The Model Manager orchestrates external compute for structure prediction (Boltz), embeddings (pLM), and spectral prediction.](data/thesis_overview_protos_v1.png)*
The following sections introduce each processor through the analysis that produced the Type II opsin dataset used throughout this thesis. Each section presents a processor, then demonstrates it on opsin data. By the end of the chapter, the framework handles sequences, structures, pocket graphs, standardized positional labels, language model embeddings, and protein annotations — and can connect any combination of these for a given protein.
Sequence Processor
Sequence identity is an unreliable predictor of molecular function. Two cone opsins can share 80% identity and absorb light 140 nm apart, because spectral tuning depends on a few pocket residues, not the whole chain. Sequence is the starting point, not the answer. Understanding what it reveals — and where it stops — requires combining sequence data with structural and functional information. Doing so at scale means managing thousands of sequences from UniProt, NCBI, and organism-specific repositories, each with different identifiers and curation standards.
The Sequence Processor manages retrieval, registration, and the analytical operations that follow. It routes requests to UniProt or NCBI based on identifier format, downloads sequences, and registers each in ProtOS. Registered sequences become the substrate for homology search (BLAST against remote databases, MMseqs2 for local high-throughput clustering), pairwise and multiple sequence alignment through BioPython, per-position conservation analysis, residue covariation via mutual information, and combinatorial mutant library generation at specified positions.
seq_proc = SequenceProcessor()
loader = SequenceLoader(processor=seq_proc)
loader.download_and_register("uniprot:P02699", name="RHO_BOVIN")


ncbi = NCBILoader(processor=seq_proc)
hits = ncbi.blast_search(
    sequence=seq_proc.load_entity("RHO_BOVIN"),
    database="swissprot", hitlist_size=500
)
ncbi.download_batch(accessions, dataset_name="opsin_atlas")


Building the Type II opsin dataset required collecting sequences across all known animal opsin subfamilies. Starting from nine query sequences — one per subfamily, spanning rod opsins, cone opsins (MWS and SWS), melanopsin, neuropsin, encephalopsin, RGR, peropsin, and parapinopsin — I used iterative BLAST searches against UniProt to retrieve homologs at increasing distance thresholds. Redundancy filtering and subfamily assignment via phylogenetic placement produced a dataset of 27,640 sequences across 13 subfamilies.
Figure 2.2 shows the sequence identity distributions for the nine subfamilies with query references. Rod opsins (n = 10,285) form a tight distribution centered around 70% identity to the bovine rhodopsin query. Cone MWS opsins (n = 4,982) and cone SWS opsins (n = 3,237) show broader diversity, with identities extending below 40%. Non-visual opsins — melanopsin (n = 1,581), neuropsin (n = 920), encephalopsin (n = 644) — form smaller clusters. Each subfamily is internally cohesive while well-separated from others, validating the classification used throughout this thesis.


*![Figure 2.2: Per-subfamily sequence identity distributions for 27,409 Type II opsins across 9 subfamilies. Each ridge shows the distribution of BLAST identity (%) to the subfamily query sequence. Rod opsins form a tight peak near 70%; cone SWS opsins show broader diversity extending below 40%. Subfamily colors follow the subfamily palette used in all subsequent figures.](ch2_protos/fig_2.2_opsin_diversity/atlas_identity_ridge.png)*


These 27,640 sequences are now registered in ProtOS. Each carries its accession, subfamily assignment, and species — and each is available to every subsequent processor.
Structure Processor
A single mutation can reposition a side chain in the binding pocket without changing the overall fold. The sequence looks nearly identical. The absorption spectrum shifts by 40 nm. Structure reveals why: the mutated residue now sits closer to retinal, altering the electrostatic environment around the conjugated chain. Conversely, two proteins with no detectable sequence homology — bacteriorhodopsin and bovine rhodopsin — bind the same chromophore through geometrically equivalent pockets. Convergent evolution produced the same spatial solution twice. No sequence alignment will find this relationship. Structural superposition on the ligand will.
Structural data is sparse. The PDB holds roughly 200,000 experimental structures for hundreds of millions of known sequences. AlphaFold DB fills the coverage gap through prediction, but predicted structures lack ligands, waters, and ions — the features that define a binding site. And the coordinate files themselves — PDB and mmCIF formats designed for archival deposition — must be parsed into representations where spatial relationships become queryable before any analysis can begin.
The Structure Processor parses coordinate files into queryable representations where atoms, residues, and their contacts are programmatically accessible. Each structure is registered in ProtOS. Relationships to sequences arise explicitly — when a sequence is extracted from a structure, or when Boltz2 predicts a structure from a sequence, the provenance is recorded. The processor identifies ligand contacts (including water-mediated and ion-mediated contacts), filters structures by chain or residue range, applies coordinate transformations and Kabsch superpositions, and merges multiple structures into multi-chain complexes.
struct_proc = StructureProcessor()
loader = StructureLoader(processor=struct_proc)
loader.download_batch(["1C3W", "1U19"], dataset_name="opsin_structures")


contacts = struct_proc.get_ligand_interactions(
    "1C3W", ligand_id="RET", chain_id="A", cutoff=4.0
)


Bacteriorhodopsin (PDB 1C3W, Type I) and bovine rhodopsin (PDB 1U19, Type II) illustrate what structural comparison reveals. Extracting residues within 4 Å of retinal yields 19 pocket residues in bacteriorhodopsin, 22 in bovine rhodopsin. Both pockets span helices 3 through 7, with the counterion (D85 in bacteriorhodopsin, E113 in bovine rhodopsin) positioned to stabilize the protonated Schiff base. Kabsch alignment on retinal atoms places the two chromophores in the same frame: the pockets overlap around the Schiff base and counterion and diverge elsewhere. Global structural alignment fails because the helix topologies differ; alignment on the ligand succeeds because both proteins face the same physical constraint — binding retinal in a manner that permits isomerization and spectral tuning.


*![Figure 2.3: Retinal-aligned overlay of bacteriorhodopsin (1C3W, blue) and bovine rhodopsin (1U19, red). Retinal (orange) occupies a geometrically similar position in both folds despite independent evolutionary origins. The counterion (D85 / E113) and Schiff base lysine (K216 / K296) are structurally equivalent, though their sequence positions differ by over 100 residues.](ch2_protos/fig_2.3_br_binding_pocket/br_bovine_aligned.png)*


Both structures are now in ProtOS, each with extracted pocket residues and ligand contacts. The binding pocket residues form spatial contact networks — representing these as graphs makes the topology explicit and comparable.
Graph Processor
Residue 85 and residue 212 in bacteriorhodopsin are 127 positions apart in sequence. In the folded protein, they sit on opposite sides of the retinal pocket, both contacting the chromophore. The sequence says they are distant. The structure says they are neighbors. A graph says both: nodes for residues, edges for spatial proximity, the relationship explicit.
Residue contact graphs formalize binding pocket topology. Nodes represent residues. Edges connect pairs whose Cα atoms fall within a distance threshold, typically 6–8 Å. The resulting network captures three-dimensional proximity independent of sequence numbering — directly comparable across proteins with different sequences, different folds, or no detectable homology. For machine learning, graphs are natural inputs: graph neural networks operate on nodes and edges, so a pocket graph becomes a direct bridge between structural coordinates and predictive models.
The Graph Processor generates these graphs from any structure already in ProtOS, optionally restricting to residues near a specified ligand to isolate binding pockets or active sites. The resulting graph is stored and linked to its source structure.
graph_proc = GraphProcessor(default_cutoff=6.0, default_level="residue")
graph_name = graph_proc.generate_graph(
    "1U19", chain="A", near_hetatm=("RET", 7.0), cutoff=6.0
)
graph_data = graph_proc.load_entity(graph_name)


Graphs can be generated at atom or residue level, individually or in batch across an entire structure dataset. Nodes can be selected by GRN position rather than residue number, producing graphs where every node carries a transferable label — comparable across proteins regardless of sequence numbering. Conversion to PyTorch Geometric tensors is built in, so that a pocket graph extracted here becomes a direct input to a graph neural network.
Extracting binding pocket graphs from both bacteriorhodopsin and bovine rhodopsin tests whether pocket topology is comparable across families. Both graphs use residues within 9 Å of retinal as nodes and Cα–Cα distances below 4 Å as edges. Both pockets produce graphs of comparable size, demonstrating that the representation works across folds despite independent evolutionary origins.


*![Figure 2.4: Binding pocket graphs for bacteriorhodopsin (1C3W, left) and bovine rhodopsin (1U19, right). Protein residues (colored nodes) and retinal (orange) shown in 3D layout with contact edges. Both pockets have similar topology.](ch2_protos/fig_2.4_pocket_graphs/graph_comparison.png)*


These graphs are already associated with their source sequences and structures. Combining them with a cross-family numbering scheme assigns every node a transferable positional label — residue 85 in bacteriorhodopsin and residue 113 in bovine rhodopsin both become position 3.28, the counterion.
GRN Processor
Every protein sequence and structure uses its own residue numbering — position 85 in one protein has no defined relationship to position 85 in another. This is not a data format problem but a biological one: insertions and deletions accumulated differently in each lineage, so functionally equivalent positions carry different numbers across homologs. Databases like GPCRdb address this by maintaining curated reference tables that map sequence positions to a family-wide coordinate system.
Generic Residue Numbering (GRN) defines such a coordinate system anchored to conserved structural features. For seven-transmembrane proteins, the Ballesteros-Weinstein convention numbers each helix 1 through 7, designating the most conserved residue on each helix as X.50. Position 3.50 is the anchor on helix 3; positions 3.49 and 3.51 are its immediate neighbors. GRN position 3.28 refers to the same structural location in any GPCR, regardless of sequence length or insertion history. The GRN Processor manages these reference tables and annotates query sequences by aligning them to the references — no structure is needed for the query itself.
grn_table, summary = seq_proc.annotate_with_grn(
    dataset_name="opsin_atlas",
    reference_table="gpcrdb_ref",
    protein_family="gpcr_a",
    output_table="atlas_grn",
)
grn_proc = GRNProcessor()
table = grn_proc.load_table("atlas_grn")


Once annotated, GRN positions propagate across modalities. The Graph Processor can select nodes by GRN label rather than residue number, producing cross-family comparable graphs. The Structure Processor can annotate coordinates with positional identity. The Sequence Processor can generate mutant libraries at specific GRN positions rather than arbitrary sequence indices.
Animal opsins are GPCRs, so Ballesteros-Weinstein numbering applies. The nine query opsins — rod opsin (B. taurus), cone MWS and cone SWS (H. sapiens), parapinopsin (I. punctatus), encephalopsin, melanopsin, neuropsin, peropsin, and RGR (all H. sapiens) — span the evolutionary breadth of Type II opsins. I annotated these nine sequences at 18 functionally important GRN positions to reveal which positions are conserved and which vary between subfamilies.
Figure 2.5a shows the resulting alignment table. The 18 positions fall into three functional categories. Conserved anchors maintain the helical scaffold: N at 1.50 and D at 2.50 coordinate a water-mediated hydrogen bond network between TM1 and TM2, while W at 4.50 stabilizes the helix bundle. Spectral tuning sites surround the chromophore: position 3.28 is the counterion (E in visual opsins, shifting to D or other residues in non-visual subfamilies), and position 3.32 varies between A, S, and T — small residues with different hydrogen-bonding capabilities that modulate the electrostatic environment around retinal. Activation microswitches form the signal transduction relay: E/DRY at 3.49–3.51 (ionic lock), PIF at 3.40 and 5.50 (inter-helix connector), CWxP at 6.47–6.50 (TM6 toggle switch), NPxxY at 7.49–7.53 (G protein coupling), and the Schiff base lysine at 7.43 — absolutely conserved because every opsin requires it to bind retinal.
One departure stands out. Cone SWS opsin has glycine at position 2.50 instead of the canonical aspartate. This is confirmed across 3,237 SWS1 subfamily members in the dataset (52% G, 38% N, 8% D), indicating evolutionary loss of the sodium coordination site in this UV/blue-sensitive lineage — consistent with the known absence of sodium sensitivity in short-wavelength opsins.


*![Figure 2.5a: GRN microswitch and spectral tuning table. Nine query opsins (rows) annotated at 18 GRN positions (columns). Amino acids colored by physicochemical property: positive (slate), negative (terracotta), aromatic (ochre), polar (sage), nonpolar (gray). Columns grouped by transmembrane helix with functional labels. The Schiff base lysine at 7.43 is absolutely conserved; spectral tuning sites (3.28, 3.32) show subfamily-specific variation.](ch2_protos/fig_2.5_grn_comparison/grn_alignment_block.png)*


Figure 2.5b maps all 18 positions onto bovine rhodopsin (PDB 1U19). The microswitches form a connected relay from the extracellular retinal-binding site through the transmembrane core to the cytoplasmic G protein interface. The physical connection between light absorption and cellular response traces through these positions.


*![Figure 2.5b: All 18 GRN positions mapped onto bovine rhodopsin (1U19). Residues shown as sticks, colored by functional category: conserved anchors (steel blue), counterion (terracotta), spectral tuning (amber), PIF connector (sage), E/DRY ionic lock (slate), transmission switch (ochre), CWxP toggle (green), Schiff base (rust), NPxxY motif (mauve). Dashed lines connect interacting pairs. Retinal chromophore in rust.](ch2_protos/fig_2.5_grn_comparison/grn_microswitches.png)*


Type I opsins are not GPCRs and Ballesteros-Weinstein does not apply. MOGRN, described in Chapter 3, fills this gap by establishing a structure-based numbering system for microbial rhodopsins anchored to the retinal-binding site. GRN positions are sparse and curated — 18 positions per sequence. Dense per-residue features, capturing patterns across entire sequences, complement them.
Embedding Processor
Protein language models (pLMs) such as ESM-2 and Ankh are neural networks trained on millions of protein sequences. They learn which amino acids co-occur, which substitutions are tolerated, and which positions are constrained — producing dense numerical representations called embeddings. The Embedding Processor wraps model inference, stores the resulting tensors as protein-linked datasets, and provides the pooling and extraction operations needed for downstream use.
emb_proc = EmbeddingProcessor(model_name="ankh_large")
embeddings = emb_proc.embed_sequences(
    sequences,
    embedding_type="per_residue",
    save_dataset="opsin_atlas__ankh_large"
)


Ankh Large produces a 1536-dimensional vector for each residue in the sequence — for a 300-residue protein, a matrix of 300 × 1536. Averaging across residues yields a single 1536-dimensional vector summarizing the whole protein. The per-residue matrix provides node features on contact graphs, where each node gets its own embedding. The mean-pooled vector enables similarity searches and clustering across the full dataset. The Embedding Processor supports ESM-2 and Ankh model families across multiple dimensionalities, with per-residue and mean-pooled embedding types. For large-scale work, streaming to disk avoids memory constraints — the 27,639 embeddings occupy ~160 MB as a cached matrix.
I embedded all 27,639 sequences with Ankh Large. Mean-pooling across sequence length yields one vector per protein. UMAP projection into two dimensions (Figure 2.6) reveals the structure of opsin embedding space without supervision — the model received no subfamily labels, spectral measurements, or structural information during training.
Subfamilies cluster. The nine query sequences, marked as stars, sit within their respective subfamily clouds. These clusters emerge without supervision — the model received no subfamily labels during training.


*![Figure 2.6: UMAP projection of 27,639 Ankh Large mean-pooled embeddings across 13 Type II opsin subfamilies. Each point is one protein, colored by subfamily. Star markers indicate the 9 query references. Subfamilies cluster without supervision: rod opsins (steel blue, n = 10,285) dominate the center; cone opsins, melanopsin, and non-visual subfamilies occupy separate regions.](ch2_protos/fig_2.6_embeddings/atlas_umap_embedding.png)*


Every protein in the dataset now carries a sequence, GRN annotations, and an embedding. What remains is linking these to the measurements and classifications that describe each protein's biology.
Property Processor
Every protein carries associated values — numbers, labels, categories that describe what is known about it. The Property Processor stores any such tabular data in CSV tables keyed to entity identifiers. A row might hold a measured λmax from a spectroscopy paper, a subfamily classification, a species name, or an experimental condition. New columns can be added as a project progresses. When LAMBDA returns a predicted λmax, that prediction enters the same table alongside the experimental measurement — queryable in the same way, linked to the same protein.
prop_proc = PropertyProcessor()
prop_proc.record_properties(
    "atlas_properties", rows,
    allow_create=True, materialize_entries=True,
)
table = prop_proc.load_table("atlas_properties")


The property table links each of the 27,640 sequences to its subfamily, sequence identity to the query, sequence length, and species. For the approximately 1,800 opsins with published absorption spectra — assembled from decades of spectroscopy across both Type I and Type II families — the property table stores measured λmax. The 27,640 sequences have embeddings and GRN annotations, but fewer than 7% have measured absorption data. This sparse coverage — rich annotations, limited measurements — is characteristic of protein science and illustrates why linking modalities matters.
Model Manager
Structural biology increasingly depends on machine learning models — structure prediction (AlphaFold2, Boltz2), protein design (RFdiffusion, LigandMPNN), fitness prediction, binding affinity estimation, and spectral property prediction. Each model expects specific input formats and produces different output formats. New models appear regularly, and without a consistent interface, adopting each one means writing bespoke preprocessing and postprocessing code.
The Model Manager treats models as configurable components. Each model is described by its expected inputs and outputs, and the manager translates between processor outputs and model-specific formats. Adding a new model requires only this input/output specification; the data management infrastructure that ProtOS already provides handles the rest.
from protos.models import ModelManager
manager = ModelManager()
inv = manager.prepare("boltz2", inputs={"sequence": seq, "name": "design_01"})
result = manager.run_and_ingest(inv)


The prepare call packages processor outputs into the format Boltz2 expects; run_and_ingest executes the job and registers the returned structure in ProtOS. The same pattern applies to any model: spectral prediction, backbone generation with RFdiffusion2, sequence design with LigandMPNN, or embedding computation at scale. Results re-enter ProtOS as properties or new data modalities, available to every processor.
At this point, each protein in the dataset may carry a sequence, GRN annotations at 18 positions, per-residue Ankh Large embeddings, and — where structures exist — binding pocket graphs. The property table makes this multi-modal representation queryable: filter by subfamily, select proteins with measured λmax, retrieve their pocket graphs and embeddings. Any combination can serve as input to a model. When a model returns predictions, those predictions enter the same table alongside the measurements — queryable in the same way, linked to the same proteins.
Discussion
This chapter introduced ProtOS through an analysis of Type II opsins. Starting from nine query sequences, I assembled a dataset of 27,640 proteins, extracted binding pocket residues from experimental structures, built residue contact graphs, annotated standardized positions, computed language model embeddings, and linked measured absorption spectra — each modality associated with the proteins it describes, each accessible to every subsequent step.
These representations provide the infrastructure for the research contributions that follow. Chapter 3 introduces MOGRN, a standardized numbering system for microbial rhodopsins, validated against 129 structures assembled and aligned through ProtOS. Chapter 4 presents LAMBDA, a cross-family spectral prediction model whose training data — pocket graphs, per-residue embeddings, GRN annotations, and measured λmax values — was built entirely through the processors described here. The Opsin Atlas extends those predictions to 47,700 sequences, a scale made practical because ProtOS manages the pipeline from sequence retrieval through spectral prediction.
The framework has technical boundaries. Database coverage includes UniProt, PDB, AlphaFold DB, and NCBI; additional sources require new loaders. GRN annotation requires a numbering system for the family of interest — GPCRs have Ballesteros-Weinstein, microbial rhodopsins now have MOGRN, but other families cannot use the GRN Processor until such systems are developed.
More fundamental is the barrier of programming. ProtOS requires Python. This excludes experimental scientists who generate the data that computational tools analyze — crystallographers, spectroscopists, biochemists who understand protein function but have never written a for-loop. An experimentalist who asks "which residues contact retinal in this structure?" understands what they want; they cannot get it without a programmer. ProtOS-MCP, described in Chapter 6, addresses this through natural language access.
________________
MOGRN - A Generic Residue Numbering System for Microbial Rhodopsins


According to ETH stipulations a cumulative thesis needs an introduction and summary for a provided publication:


Introduction


<to be rewritten>




Summary 


<to be rewritten>




Current Draft (combining introduction and summary):


This chapter summarizes the research contribution presented in the accompanying submitted publication: "A Generic Residue-Numbering system for Microbial Rhodopsins". The full manuscript is included at the end of my cumulative thesis.


Comparative analysis of microbial rhodopsins requires a way to identify equivalent positions across the superfamily. This is the problem that generic residue numbering systems solve. For GPCRs, including type II opsins, the Ballesteros-Weinstein system provides this foundation: position 3.50 refers to the conserved arginine of the DRY motif in any Class A receptor, and this common vocabulary enabled GPCRdb to integrate sequences, structures, ligands, and mutations into a unified resource. Microbial rhodopsins lacked an equivalent system. Each laboratory developed ad hoc conventions—some referenced bacteriorhodopsin positions, others channelrhodopsin-2, still others the C1C2 chimera—and comparing equivalent positions across publications required manual alignment for every analysis.


The difficulty is that sequence identity between major microbial rhodopsin classes falls as low as 10-12%. Ion pumps, channels, sensors, and enzyme-fused variants share the seven-transmembrane fold but have diverged extensively. Standard sequence alignment cannot reliably identify equivalent positions across such evolutionary distances. A numbering system for microbial rhodopsins must therefore be anchored to structure rather than sequence.


The MO (Microbial Opsin) numbering system uses the retinal-binding pocket as this structural anchor. Microbial rhodopsin bind all-trans retinal via a Schiff base linkage to a conserved lysine on helix 7, and the geometry of this pocket remains consistent even when overall sequence identity falls below 20%. The Schiff base-forming lysine becomes position 7.50 by definition. Anchor positions for helices 1 through 6 are defined as the residue closest to retinal on each helix. Following the Ballesteros-Weinstein convention, each position receives a two-part number indicating helix and position relative to the anchor, with residues toward the N-terminus receiving lower numbers and those toward the C-terminus receiving higher numbers.


This system maps functionally important sites to standardized coordinates. The Schiff base counterions occupy positions 3.45 and 7.46. The TM3 motif at positions 3.45-3.49-3.56 determines ion pump specificity: outward proton pumps like bacteriorhodopsin carry DTD (aspartate-threonine-aspartate), inward proton pumps carry FSE, chloride pumps carry TSA or NTQ, and sodium pumps carry NDQ. Spectral tuning switches cluster at positions 3.53, 4.51, 6.54, and 7.49. The non-G rule controlling retinal planarity operates through position 4.54. Lateral fenestration sites for retinal uptake occur at positions 5.44 and 5.47. These patterns become immediately comparable in MO coordinates rather than requiring translation between protein-specific residue numbers.


The system accommodates non-canonical architectures. Heliorhodopsins have inverted membrane topology, yet the binding pocket geometry is preserved and MO coordinates apply without modification. Enzyme-fused rhodopsins have an additional TM0 helix, but the numbering annotates the seven-helix retinal-binding core. Gaps and insertions arising from local structural distortions receive systematic notation.


Validation against 129 structures spanning all major functional classes—proton pumps, chloride pumps, sodium pumps, cation channels, anion channels, sensory rhodopsins, and enzyme-coupled variants—demonstrated sub-angstrom accuracy (0.51-0.75 Å iRMSD) for the binding pocket region that defines the anchor positions. Application to approximately 40,000 non-redundant sequences from genomic and metagenomic sources revealed 31 sequence clusters, of which 14 contain characterized rhodopsins and 17 contain only uncharacterized sequences representing unexplored functional diversity.


Chapter 2 described how the GRNProcessor annotates Type II opsins: sequences align to GPCRdb reference tables, and the alignment transfers Ballesteros-Weinstein coordinates from structurally characterized references to new sequences. Type I opsins lacked equivalent infrastructure—no reference table existed.


The MOGRN system solves this. I performed a structural analysis of 129 microbial rhodopsins, spanning all major functional classes, which produced a curated alignment where each column represents a structurally equivalent position and each row represents a characterized family member.[i] This reference table is registered in ProtOS, enabling the same workflow for Type I that GPCRdb enables for Type II: query sequences align to the reference, and the GRNProcessor transfers MO coordinates based on alignment position.


Consider bacteriorhodopsin, the founding member of the microbial rhodopsin family. The crystal structure (PDB 1C3W) contains 248 residues forming seven transmembrane helices around a retinal chromophore. Key functional positions have been characterized through decades of mutagenesis, spectroscopy, and structural biology, yet the literature references these positions by sequence number—D85, T89, D96, D212, K216—which apply only to this specific protein. Given a channelrhodopsin or a heliorhodopsin, identifying equivalent positions requires manual structural alignment.


<HERE IS A TABLE WITH IMPORTANT GRN POSITIONS>


MO Position
	Function
	HsBR
	C1C2
	3.45
	Counterion
	D85
	E162
	3.49
	Proton Transfer
	T89
	T166
	3.56
	Proton Donor
	D96
	H173
	7.46
	Counterion
	D212
	D292
	7.50
	Schiff base
	K216
	K296
	



The counterion at position 3.45 is aspartate in the proton pump (D85) and glutamate in the channel (E162)—both negatively charged, stabilizing the protonated Schiff base. The proton donor at 3.56 is aspartate in the pump (D96) but histidine in the channel (H173), reflecting their different mechanisms. The Schiff base lysine at 7.50 is conserved in both (K216, K296). These comparisons, which previously required manual structural alignment, become routine queries against the GRN table. The TM3 motif at positions 3.45-3.49-3.56 distinguishes functional classes across the entire superfamily:






Function
	3.45
	3.49
	3.56
	Example
	Outward H+ pump
	D
	T
	D
	HsBR
	Inward H+ pump (SzR)
	F
	S
	E
	SzR4
	Inward H+ pump (XeR)
	D
	T
	A/L/S
	NsXeR
	Cl- pump (archaeal)
	T
	S
	A/D
	NpHR
	Cl- pump (bacterial)
	N
	T
	Q
	NmClR
	Na+ pump
	N
	D
	Q
	KR2
	





This pattern, described in the accompanying publication, becomes queryable once MO coordinates are assigned. Rather than manually extracting motifs from structural alignments, the question "what TM3 motif does this sequence have?" reduces to reading positions 3.45, 3.49, and 3.56 from the GRN table.


<HERE IS A FIGURE SHOWING THESE IMPORTANT GRNs highlighted in 1c3w>


[FIGURE 3.1: MO numbering enables cross-family comparison. Shown is 1c3w. (old figure had 2 structures, but I only show 1, but with residues at key grn positions highlighted). The counterion (3.45) is D85 in HsBR and E162 in C1C2; the Schiff base lysine (7.50) is K216 and K296 respectively. Sequence positions differ by 77-80 residues, yet MO coordinates identify equivalent sites. (C) The binding pocket represented as a contact graph with MO-annotated nodes. This representation, with standardized labels across the superfamily, enables the cross-family learning described in Chapter 4.]


The critical feature of the reference table is its coverage. Aligning a channelrhodopsin sequence to bacteriorhodopsin alone produces unreliable coordinates because the sequences can share less than 15% identity—too divergent for an error-free alignment. But the MOGRN reference includes representatives of all major sub-families of microbial rhodopsins, so my alignments succeed. Even heliorhodopsins, enzyme rhodopsins, and other distant families can be annotated: each is represented in the reference, so each can be reliably annotated. With standardized coordinates registered in the system, cross-family queries become simple: which residues occupy position 3.45 across all characterized channelrhodopsins, or how the TM3 motif varies across ion pump families, are questions answerable through single queries rather than manual compilation.


The binding pocket of bacteriorhodopsin contains 69 residues within 9 Å of retinal, spanning helices 1 through 7. Once MO coordinates are assigned, these residues form the nodes of a contact graph where edges connect spatially adjacent residues (with a distance cutoff of 4Å). Position 3.45 connects to 3.46, 7.46, and 7.50; position 7.50 connects to the retinal-contacting residues on helices 3, 6, and 7. This graph topology is conserved across microbial rhodopsins because the binding pocket geometry is conserved. What varies is the amino acid identity at each node—the substitutions that determine spectral properties.


This graph representation bridges MOGRN to LAMBDA. The standardized coordinates provide consistent node labels across the superfamily; the graph topology encodes the spatial relationships that determine function; protein language model embeddings capture the amino acid identity and sequence context at each position. Chapter 4 describes how a graph attention network learns from these representations to predict spectral properties across families. The full methodology, detailed results, supplementary figures, and complete reference list are provided in the accompanying publication included in this thesis.


LAMBDA - Cross-Family Spectral Prediction


The preceding chapter described MOGRN, a generic residue numbering system for microbial rhodopsins. This chapter presents LAMBDA (Light Absorption Modeling through Binding Domain Analysis), which uses GRN coordinates to predict opsin spectral properties from sequence. Existing methods treat spectral prediction as a family-specific regression problem. LAMBDA instead predicts how a binding pocket tunes retinal absorption across chromophore conformations. This reframing reflects the underlying biology—the same protein can bind retinal in multiple states, each with distinct spectral properties determined by the same binding pocket environment—and motivates a structure-based approach that extends to any retinal-binding protein.
Three capabilities follow from this formulation. LAMBDA predicts λmax for multiple chromophore states (11-cis, all-trans, protonated, deprotonated) from one model. Type I and type II opsins train jointly because their binding pockets align through the chromophore despite different global folds, testing whether spectral tuning principles transfer across families. And the approach extends to new folds given appropriate GRN mappings and training examples, as demonstrated with hCRBPII. These capabilities serve three applications: mapping the spectral landscape of all opsins (the Opsin Atlas), addressing spectral tuning as a protein engineering challenge, and understanding how retinal-binding pockets might be incorporated into synthetic folds to couple light activation to arbitrary protein functions. The chapter demonstrates that standardized positional annotation—MOGRN for type I opsins, Ballesteros-Weinstein for type II—enables cross-family learning about chromophore-protein interactions, providing a foundation for understanding spectral tuning across retinal-binding proteins.


Introduction


Optogenetics depends on matching light wavelength to protein response. Type I (microbial) opsins—channelrhodopsins, bacteriorhodopsins, halorhodopsins—provide the ion channels and pumps that enable neural activation and silencing. Type II (animal) opsins—rhodopsins, melanopsins, cone opsins—underlie visual neuroscience and increasingly serve as light-activated GPCRs for controlling intracellular signaling. In both cases, the absorption maximum λmax determines which wavelengths activate the protein, and selecting or engineering opsins with specific λmax values is a core challenge. Red-shifted opsins (λmax > 580 nm) enable deeper tissue penetration because longer wavelengths scatter less in biological tissue. Spectrally separated pairs—one blue-absorbing, one red-absorbing—allow multiplexed control of distinct cell populations in the same preparation. Many optogenetic applications also require a distinct off-switch: bistable opsins can be both photoactivated and photoreversed, but this bidirectional control requires sufficient separation between dark-state and activated-state absorption maxima. If the two states absorb at similar wavelengths, a single light source drives both forward and reverse photoreactions, precluding selective control. Predicting λmax for both chromophore states of the same protein, and the spectral gap between them, is therefore as important as predicting a single absorption maximum.


Beyond opsins, the landscape of retinal-binding proteins is expanding. Engineered systems like human cellular retinol binding protein II (hCRBPII) demonstrate that retinal can be bound and spectrally tuned in protein folds entirely unrelated to opsins. As protein engineering capabilities grow—through directed evolution, computational design, and de novo fold generation—the prospect of incorporating retinal-binding pockets into novel protein scaffolds creates the possibility of coupling light activation to functions beyond the ion transport, channel gating, and GPCR signaling that natural opsins provide. Understanding how binding pocket architecture determines spectral properties, independent of global fold, is a prerequisite for this direction.


Light absorption follows the relationship E = hc/λ: a photon is absorbed when its energy matches the gap between electronic states of the chromophore. The protein environment tunes this gap through electrostatic interactions with the conjugated polyene chain of retinal. The counterion—a negatively charged residue 3–4 Å from the protonated Schiff base—is the primary determinant, but the entire network of binding pocket residues contributes, and single mutations at key positions shift λmax by 10–40 nm. All retinal-binding proteins use the same chromophore yet span λmax values from ~350 nm (UV) to ~650 nm (far-red), with the variation arising along two independent axes: geometric isomerism and protonation state. Type II opsins bind 11-cis retinal in the dark state; type I opsins and photoactivated type II opsins bind all-trans retinal. Independently, the Schiff base linkage to the conserved lysine can be protonated (the dominant state for most opsins, absorbing in the visible range) or deprotonated (as in UV-sensitive SWS1 opsins, which bind 11-cis retinal but absorb below 400 nm). Both properties—isomer state and protonation—are determined by the same binding pocket environment (Figure 4.1). Because energy is inversely proportional to wavelength, spectral tuning becomes increasingly difficult to resolve at long wavelengths: a 10 nm shift near 400 nm represents ~0.08 eV, while the same shift near 600 nm represents only ~0.03 eV.


[FIGURE 4.1: Spectral tuning in opsins. (A) The relationship between energy gap and absorption wavelength (E = hc/λ). Equal wavelength differences correspond to smaller energy differences at longer wavelengths—a 10 nm shift near 400 nm represents ~0.08 eV, while the same shift near 600 nm represents only ~0.03 eV. (B) Retinal Schiff base configurations: 11-cis protonated (dark state in type II opsins), all-trans protonated (type I opsins and activated type II), and deprotonated (UV-sensitive opsins).]


Tens of thousands of opsin sequences exist in databases, but fewer than 3,000 have measured λmax values. Several computational methods predict spectral properties: OPTICS predicts λmax for type II opsins using sequence features and phylogenetic information trained on the VPOD dataset; Inoue et al. trained a regression model for type I opsins from amino acid composition at key positions; RhoMax uses a graph neural network on type I opsin binding pocket structures, requiring experimental or predicted structures as input. Each achieves reasonable accuracy within its domain, but they share two fundamental limitations. They are fold-specific—OPTICS cannot predict type I opsins, the Inoue model cannot predict type II opsins, none can handle retinal-binding proteins with different folds. And they predict only a single λmax for their target family's native chromophore state, unable to predict activated states, deprotonated states, or the spectral gap between chromophore states that determines whether bidirectional control is feasible. At a deeper level, pure sequence-based methods learn statistical correlations—a charged residue at a particular sequence position correlates with a blue shift—which captures patterns within a family but does not generalize, because the same spectral effect arises from different sequence positions in different folds.


LAMBDA addresses these limitations by framing spectral prediction as a question about binding pockets rather than sequences. The model predicts λmax for multiple retinal conformations and protonation states simultaneously from a single shared representation. Predicting both dark-state (11-cis) and activated-state (all-trans) absorption maxima for the same protein yields the spectral shift Δλ between on and off states—a quantity that determines whether bidirectional optogenetic control is feasible and that no existing method can estimate.


Since spectral tuning is determined by the binding pocket, the natural representation for prediction is the pocket itself—the residues surrounding retinal and their spatial contacts—rather than the full protein sequence or the global fold. In LAMBDA, binding pockets are represented as graphs: nodes are binding pocket residues, edges encode spatial contacts between them. This topology captures which residues interact, independent of their sequence positions or the global architecture that places them there. Figure 4.2 illustrates this across three structurally unrelated protein families. Type I opsins (bacteriorhodopsin, 1C3W) and type II opsins (bovine rhodopsin, 1U19) are both seven-transmembrane alpha-helical bundles, but with independently evolved architectures—different helix tilts, loop connectivities, and retinal binding orientation—and no detectable sequence homology. hCRBPII (4QYP) adopts an entirely different fold—a beta-barrel—yet engineered variants bind retinal and span over 200 nm of spectral tuning through only nine point mutations. Despite these architectural differences, the graph representation reduces each binding pocket to the same format: nodes are residues within contact distance of retinal, edges encode spatial adjacency within 4 Å. The opsin graphs have similar sizes (68 and 69 nodes); the hCRBPII graph has comparable complexity (67 nodes) despite the entirely different fold. The same model architecture processes all three graph types, learning spectral tuning determinants from binding pocket composition regardless of the surrounding protein scaffold.


[FIGURE 4.2: Binding pocket structures and graph representations for three retinal-binding protein families. Top: crystal structures with pocket residues shown as sticks. Bottom: corresponding contact graphs used as LAMBDA input. (A, D) Bacteriorhodopsin, Type I opsin. (B, E) Bovine rhodopsin, Type II opsin. (C, F) hCRBPII, a beta-barrel protein. Opsin residues colored by transmembrane helix (TM1–TM7).]


A binding pocket graph derived from a crystal structure is the definitive representation, but structures exist for only a fraction of known opsins. Two components make the approach scalable. Generic Residue Numbering (GRN) systems provide standardized positional coordinates for transmembrane proteins: the Ballesteros-Weinstein system for type II opsins and MOGRN—described in the preceding chapter—for type I opsins. GRN positions are defined relative to conserved structural features, so a sequence annotated with GRN implicitly specifies which binding pocket positions are present. Because the seven-transmembrane fold is conserved within each opsin family, the contact pattern between GRN positions in the binding pocket is highly conserved—the same core edges connect the same positions across opsins within each family, though flexible loop regions may contribute variable contacts. Binding pocket graphs can therefore be constructed from sequence alone, using the reference topology as a template. Aligning reference structures from both families on retinal reveals that certain positions occupy equivalent spatial locations relative to the chromophore: position 7.43 (type II) and 7.50 (type I) are both the Schiff base lysine; 3.28 and 3.57 are both in the counterion region. Treating mapped positions as equivalent graph nodes enables cross-family learning despite the independent evolutionary origins of these folds. Protein language model embeddings from Ankh-large (Elnaggar et al. 2023), chosen for its balance of embedding quality and computational efficiency, provide 1536-dimensional per-residue feature vectors that serve as node features, encoding amino acid identity and evolutionary context. Both GRN annotation and pLM embeddings require only a protein sequence as input.


Two pathways construct LAMBDA input graphs, depending on whether a structure is available (Figure 4.3). The structure-based path processes any retinal-binding protein with a known or predicted structure: binding pocket residues are identified based on proximity to retinal, GRN coordinates are assigned, per-residue pLM embeddings are computed, and the contact graph is assembled. The sequence-only path annotates the sequence with GRN positions, applies the family-specific binding pocket topology directly, and uses pLM embeddings as node features—this is the path used for the Opsin Atlas predictions on 47,700 sequences. Both paths produce the same output: a binding pocket graph where each node carries a positional encoding and a pLM embedding, and edges encode spatial contacts. A graph attention network learns the mapping from binding pocket composition to spectral properties, trained on 2,120 proteins with measured absorption values across three protein folds.


![Figure 4.3: Data flow for the two binding pocket graph construction pathways. The structure-based path (top) processes any retinal-binding protein through Structure Processor → GRN annotation → Graph assembly. The sequence-only path (bottom) exploits conserved GRN systems to construct graphs directly from sequence via GRN annotation → graph topology lookup → embedding enrichment. Both paths produce the same graph format consumed by LAMBDA.](data/thesis_overview_protos_v1.png)


Methods


Datasets


Training data were compiled from three sources that together span both opsin families and multiple retinal conformations.


VPOD 1.3 (Visual Physiology Opsin Database) contains 1,253 type II opsin sequences spanning vertebrate and invertebrate species. The dataset includes both wild-type and experimentally characterized mutant opsins, with λmax values for 11-cis retinal ranging from 350–611 nm. VPOD provides the largest collection of animal opsin spectral data, spanning vertebrate visual opsins, invertebrate opsins, and non-visual opsins such as melanopsin.


The Inoue dataset expands coverage to type I (microbial) opsins, containing 785 sequences from 30 species. These sequences were collected from NCBI, metagenomic databases, and the Tara Oceans project, with experimentally determined λmax values for all-trans retinal. The dataset spans bacteriorhodopsins, halorhodopsins, channelrhodopsins, and sensory rhodopsins, with absorption maxima ranging from 436–644 nm.


To enable prediction of the all-trans retinal state for type II opsins, training data were augmented with activated-state λmax values collected from the literature. For 31 type II opsins with reported photoactivated or meta-state absorption maxima, the all-trans λmax was recorded alongside the dark-state (11-cis) value. This approach is necessarily approximate: "activated state" encompasses different photointermediates depending on the opsin's photocycle (meta II in visual opsins, the stable photoproduct in bistable opsins). Nevertheless, these dual-state annotations are suitable as ground truth for training the all-trans prediction head on type II opsins. These 31 opsins were assigned exclusively to the training split to maximize the model's exposure to dual-state measurements.


hCRBPII (human cellular retinol binding protein II) represents an engineered system where Wang et al. (2012) created retinal-binding variants through targeted mutations. This dataset of 51 sequences demonstrates spectral tuning spanning 425–644 nm with all-trans retinal—a range of 219 nm achieved through only nine point mutations. hCRBPII adopts a lipocalin fold unrelated to opsins, providing a test case for cross-fold generalization. As with type I and type II opsins, the hCRBPII binding pocket was aligned to retinal and equivalent positions mapped to the nearest GRN coordinates, enabling the same graph-based representation.


| Dataset | Samples | Fold | Retinal | λmax range (nm) |
|---------|---------|------|---------|-----------------|
| VPOD 1.3 | 1,253 | Type II | 11-cis | 350–611 |
| Inoue | 785 | Type I | all-trans | 436–644 |
| Dual-state (this work) | 31 | Type II | both | varies |
| hCRBPII | 51 | Lipocalin | all-trans | 425–644 |
| **Total** | **2,120** | | | |


The distribution of measured λmax values across these datasets is shown in Figure 4.4. The diversity of these datasets—spanning different opsin types, species, and retinal conformations—necessitates a multi-output approach. Type II opsins bind 11-cis retinal in the dark state, while type I opsins bind all-trans retinal. The model addresses this by predicting λmax for multiple retinal states simultaneously, allowing it to learn shared spectral tuning principles while capturing conformation-specific effects. This creates an inherent asymmetry: the all-trans prediction head is trained on type I opsins (Inoue, n=785), hCRBPII (n=51), and the 31 dual-state type II opsins, while the 11-cis head is trained exclusively on type II data (VPOD, n=1,253). The model does produce 11-cis predictions for type I opsins, but these are extrapolations with no training signal—type I opsins natively bind all-trans retinal, and predicting their absorption with 11-cis or other isomers (9-cis, 13-cis) would require isomer-specific training data that does not currently exist at scale.


Binding Pocket Graphs


Type I (microbial) and type II (animal) opsins share no detectable sequence homology, yet both evolved seven-transmembrane architectures that bind retinal. LAMBDA exploits this convergence by representing binding pockets as graphs aligned on the chromophore itself. A single reference structure defines the binding pocket graph for each protein family: bovine rhodopsin (PDB: 1U19) for type II opsins and bacteriorhodopsin (PDB: 1C3W) for type I opsins. Within each reference structure, binding pocket residues are identified as those with any sidechain atom within 9 Å of retinal. These residues become nodes in the graph. Edges connect residue pairs with atoms within 4 Å of each other, encoding the network of spatial contacts through the binding pocket.


To enable cross-family learning, the two reference structures are aligned on the retinal polyene chain (atoms C7–C15) using Kabsch superposition. After alignment, binding pocket residues from both families that occupy equivalent spatial locations are identified through sidechain volume overlap: for each pair of GRN positions (one from each family) whose Cα atoms fall within 2 Å, a voxelized sidechain overlap is computed, and pairs exceeding 15% overlap of the smaller sidechain volume are mapped in a greedy one-to-one matching. This procedure yields 25 cross-family position pairs out of ~70 binding pocket positions per family. Positions without a cross-family partner are retained as family-specific nodes. The Schiff base lysine (7x43 in type II, 7x50 in type I) is hardcoded as a mapped pair.


| Structural feature | Type II (animal) | Type I (microbial) |
|-------------------|------------------|-------------------|
| Schiff base Lys | 7x43 | 7x50 |
| Counterion region | 3x28 | 3x57 |
| Retinal contact 1 | 7x39 | 7x46 |
| Retinal contact 2 | ECL2 | 4x51 |
| Retinal contact 3 | 2x58 | 7x45 |


Mapped positions share graph node indices during training, enabling the model to learn that residues at equivalent spatial locations serve analogous roles in spectral tuning despite belonging to different protein folds. Unmapped positions contribute family-specific nodes that capture tuning determinants unique to each fold.


Preprocessing


Generating binding pocket graphs for any opsin sequence without requiring experimental structures is achieved through Generic Residue Numbering (GRN) systems, which assign structural coordinates based on sequence alignment alone.


GRN systems label positions within transmembrane proteins using a standardized notation: the helix number followed by a position relative to a conserved reference residue (e.g., 3x50 denotes position 50 in helix 3). For type II opsins, the established Ballesteros-Weinstein numbering system is used. For type I opsins, MOGRN is used—the GRN system for microbial rhodopsins described in the preceding chapter, with reference positions (Xx50) chosen as the residue closest to retinal in each helix.


The preprocessing pipeline was implemented in ProtOS, providing standardized procedures for assigning GRN coordinates to opsin sequences. The pipeline operates as follows:


1. Family classification: Input sequences are classified as type I or type II based on sequence similarity to reference opsins using MMseqs2.
2. Reference selection: The most similar reference sequence with known GRN assignments is identified.
3. Sequence alignment: Pairwise alignment against the reference using Biopython's pairwise2 module.
4. GRN transfer: Positions are labeled according to the alignment, assigning GRN coordinates to each residue.
5. Graph construction: Binding pocket residues (those with GRN positions in the reference graph) are extracted, and the family-specific edge topology is applied.
6. Feature generation: Protein language model embeddings are computed for each node using Ankh-large.


This pipeline enables LAMBDA to accept any opsin sequence as input, requiring only the amino acid sequence. The GRN system provides the structural context—which positions are in the binding pocket and how they relate spatially—while the pLM embeddings capture the biochemical properties of the specific amino acids at each position.


Model and Training


LAMBDA uses a graph neural network that processes binding pocket graphs to predict λmax for multiple retinal conformations.


Input representation. Each node in the graph corresponds to a binding pocket residue and carries two feature types: (1) a positional encoding derived from the GRN coordinate, capturing the residue's structural location relative to retinal, and (2) a 1536-dimensional embedding from Ankh-large, capturing evolutionary and biochemical context. The positional encoding is learned during training, allowing the model to discover which binding pocket locations matter most for spectral tuning.


Message passing. The encoder uses a Graph Convolutional Network (GCN) with residual connections to update node representations through neighborhood aggregation. The GCN layer propagates information between connected residues, integrating local interactions across the binding pocket.


Pooling. A position-aware attention pooling mechanism with 32 heads generates a global representation from node-level features. This mechanism uses the GRN positional encodings -One-hot encoding of the mapped binding pocket position encoded through an embedding layer- to compute attention weights over residue contributions, enabling the model to learn multiple complementary views of position-dependent importance.


Multi-task output. The pooled representation feeds into five regression heads that predict λmax across retinal conformations and protonation states. For both 11-cis and all-trans retinal, two heads operate in parallel: one predicts λmax for protonated Schiff base states only (λmax > 400 nm), while the other predicts λmax across the full spectral range including deprotonated states. A fifth head predicts λmax for deprotonated Schiff base (UV-absorbing states, λmax < 400 nm). Protonation state is classified by a threshold at 400 nm, chosen based on the bimodal distribution of λmax values in the training data: opsins with λmax below this boundary are classified as having a deprotonated Schiff base, and the corresponding UV head prediction is used; otherwise the protonated-state head prediction is reported. All prediction heads share the same encoder—the same learned representation of binding pocket structure feeds all outputs. This shared-encoder architecture reflects the biological reality that a single binding pocket determines spectral properties across chromophore states, and enables generalization to additional retinal conformations (9-cis, 13-cis) as training data become available.


Loss function. Training uses a combined loss that sums mean squared error across all prediction tasks, with masking to handle missing labels (e.g., type I opsins lack 11-cis measurements). The full-range heads (which predict across both protonated and deprotonated states) receive half weight relative to the state-specific heads, as they serve primarily as a regularizer that encourages globally consistent predictions. The split at 400 nm into separate protonated and UV heads allows the model to learn distinct distributions for each protonation state rather than fitting a single non-Gaussian distribution.


Optimization. The model is trained with a learning rate of 2×10⁻⁴ using a ReduceLROnPlateau schedule that decays the rate to a minimum of 1×10⁻⁷ when validation loss plateaus. A batch size of 2 is used; larger batch sizes consistently degraded learning, likely because the small dataset and high variance across opsin families benefit from the noisier gradient estimates of very small batches.


Regularization. To prevent overfitting, dropout is applied within the GCN encoder and attention pooling layers, weight decay on all parameters, and early stopping based on validation loss with a patience of 50 epochs.


Data splitting. The combined dataset is divided into training (80%), validation (10%), and test (10%) sets using stratified sampling. Stratification is performed at two levels: by source dataset (VPOD, Inoue, hCRBPII) and by species within each dataset. The 31 dual-state opsins are assigned exclusively to the training split to maximize exposure to dual-state measurements. The remaining data are split to ensure representative sampling across opsin types and taxonomic groups. For species with fewer than 3 samples, random assignment is used to avoid stratification failures.


Evaluation metrics. Mean absolute error (MAE) in nanometers after denormalizing predictions to the original λmax scale, coefficient of determination (R²), and the fraction of predictions within 5 nm and 10 nm of experimental values are reported. For protonation state, classification accuracy is reported.


Normalization. Target values are normalized to [0, 1] using the observed ranges in training data: 11-cis λmax (401–611 nm), all-trans λmax (401–644 nm), and UV λmax (340–399 nm).


Opsin Atlas


A comprehensive sequence collection was assembled by mining the NCBI non-redundant protein database to achieve broad coverage of opsin diversity across all major subfamilies in both type I and type II families. A phylogenetically informed sampling strategy was designed using BLAST searches seeded from representative sequences of each major opsin subfamily. Each query was searched against NCBI nr using BLASTp, retrieving up to 5,000 hits per query. Because queries from related subfamilies often retrieve overlapping sets of sequences, each protein was assigned to the subfamily of the query to which it had the highest sequence identity. This similarity-based classification supersedes NCBI annotations, which frequently use "bacteriorhodopsin" as a generic label for diverse microbial rhodopsins regardless of their phylogenetic placement—for example, 46% of type I sequences carry "bacteriorhodopsin" in their NCBI annotation, yet similarity-based classification distributes these across eight distinct families, reflecting their actual evolutionary relationships. All per-query results were then merged into unified type I and type II tables.


For type I (microbial) opsins, 13 query sequences covering 10 functional subfamilies were used:


| Subfamily | Query | Accession |
|-----------|-------|-----------|
| Proton pump | Bacteriorhodopsin (*H. salinarum*) | P02945 |
| Proton pump | Archaerhodopsin-1 (*H. salinarum*) | P69051 |
| Proton pump | Archaerhodopsin-2 (*H. salinarum*) | P29563 |
| Chloride pump | Halorhodopsin (*H. salinarum*) | P0DMH7 |
| Sensory rhodopsin I | SRI (*H. salinarum*) | P0DMH8 |
| Sensory rhodopsin II | SRII (*N. pharaonis*) | P42196 |
| Cation channel | Channelrhodopsin-1 (*C. reinhardtii*) | A0A2K3CXC9 |
| Cation channel | Channelrhodopsin-2 (*C. reinhardtii*) | Q8RUT8 |
| Anion channel | GtACR1 (*G. theta*) | L1JRS2 |
| Green-absorbing PR | Proteorhodopsin (*SAR86*) | Q9F7P4 |
| Blue-absorbing PR | Proteorhodopsin (*HOT75*) | Q9AFF7 |
| Heliorhodopsin | HeR (metagenome) | A0A2P2C3K4 |
| Xanthorhodopsin | Xanthorhodopsin (*S. ruber*) | Q2S2F8 |


For type II (animal) opsins, 14 query sequences covering 12 subfamilies were used:


| Subfamily | Query | Accession |
|-----------|-------|-----------|
| Rod opsin | Rhodopsin (*Bos taurus*) | P02699 |
| Rod opsin | Rhodopsin (*H. sapiens*) | P08100 |
| Short-wavelength-sensitive cone opsin 1 (SWS1) | OPN1SW (*H. sapiens*) | P03999 |
| Medium-wavelength-sensitive cone opsin (MWS) | OPN1MW (*H. sapiens*) | P04001 |
| Long-wavelength-sensitive cone opsin (LWS) | OPN1LW (*H. sapiens*) | P04000 |
| Encephalopsin (OPN3) | OPN3 (*H. sapiens*) | Q9H1Y3 |
| Melanopsin (OPN4) | OPN4 (*H. sapiens*) | Q9UHM6 |
| Neuropsin (OPN5) | OPN5 (*H. sapiens*) | Q6U736 |
| Parapinopsin | Parapinopsin (*I. punctatus*) | O42266 |
| Pinopsin | Pinopsin (*G. gallus*) | P51475 |
| Peropsin | Peropsin (*H. sapiens*) | O14718 |
| Retinal G protein-coupled receptor (RGR) | RGR (*H. sapiens*) | P47804 |
| Teleost multiple tissue opsin (TMT) | TMT opsin (*D. rerio*) | R9R6C7 |
| Vertebrate ancient opsin (VA) | VA opsin (*O. masou*) | O13018 |


The retrieved sequences underwent quality filtering. Sequences exceeding 500 residues (likely multi-domain proteins or fusion constructs) were removed. To eliminate redundancy while preserving phylogenetic diversity, exact sequence duplicates were removed and cases where the same gene from the same species appeared under multiple accession numbers were filtered, while retaining orthologous sequences from different species. Most critically, each sequence was validated through the GRN annotation pipeline, retaining only sequences that (1) contained the conserved Schiff base lysine at the expected GRN position (7.43 for type II, 7.50 for type I), and (2) achieved sufficient GRN coverage to generate the input graphs for LAMBDA.


For prediction, LAMBDA was applied with output heads matched to each opsin type's native chromophore configuration. Type I opsins, which bind all-trans retinal, received predictions for λmax^AT. Type II opsins received predictions for their dark-state chromophore (λmax^11-cis), but λmax^AT was additionally predicted for all type II sequences. This dual prediction for type II opsins—though training data for their all-trans state is limited to the 31 dual-state sequences—enables estimation of spectral shifts upon photoactivation, a property critical for optogenetic applications. All data management, sequence processing, and GRN annotation were performed using ProtOS.


Results


LAMBDA was evaluated on the held-out test set (10% of data, stratified by dataset and species). Performance is reported for each prediction target alongside published results from family-specific methods where available.


| Metric | LAMBDA | OPTICS | Inoue et al. | RhoMax |
|--------|--------|--------|--------------|--------|
| **MAE ± std (nm)** | | | | |
| Type II (11-cis) | **5.18 ± 0.82** | 5.49 | -- | -- |
| Type I (all-trans) | **6.86 ± 0.89** | -- | 7.80 | 6.83 |
| hCRBPII (all-trans, n=6) | **5.84 ± 1.13** | -- | -- | -- |
| **R²** | | | | |
| Type II (11-cis) | **0.972** | 0.964 | -- | -- |
| Type I (all-trans) | **0.894** | -- | -- | -- |
| hCRBPII (all-trans, n=6) | **0.978** | -- | -- | -- |
| **Other** | | | | |
| Protonation acc. | 98.3% | -- | -- | -- |
| Within 5 nm (11c) | 77.6% | -- | -- | -- |
| Within 5 nm (AT) | 52.7% | -- | -- | -- |
| Within 10 nm (11c) | 93.9% | -- | -- | -- |
| Within 10 nm (AT) | 83.9% | -- | -- | -- |


Evaluation protocols differ across methods. LAMBDA reports held-out test set performance (10% stratified split). OPTICS uses k-fold cross-validation on VPOD WDS (n=1,211) with amino acid property encoding (Frazer & Oakley 2025). Inoue et al. report within-family evaluation on 884 type I sequences (Karasuyama et al. 2018). RhoMax reports median absolute error across 4 family-aware cross-validation splits on 884 type I sequences (mean AE = 10.45 nm; Sela et al. 2024) and requires structures as input. Despite these protocol differences, all methods operate on comparable dataset sizes and the reported accuracies are broadly comparable. The hCRBPII test set contains only 6 samples, limiting statistical power.


LAMBDA achieved a mean absolute error of 5.18 ± 0.82 nm for type II opsins (11-cis retinal, n=119) and 6.86 ± 0.89 nm for type I opsins (all-trans retinal, n=87) on the held-out test set (Figure 4.5). These values reflect the model's actual output, using the protonation-state classification described in Methods to select between head predictions. The model correctly classified protonation state with 98.3% accuracy. For hCRBPII (42 training, 3 validation, 6 test samples), the model achieved an MAE of 5.84 ± 1.13 nm (R² = 0.978)—comparable to opsin performance despite the fundamentally different lipocalin fold. The small test set limits statistical confidence, but the result demonstrates that the binding domain graph framework accommodates non-opsin folds when training examples and appropriate GRN mappings are available.


These results place LAMBDA's accuracy in the same range as the best family-specific methods while predicting across chromophore conformations and protein families from a unified model. That joint training does not degrade within-family accuracy suggests that spectral tuning principles transfer across folds and that the cross-family position mapping captures genuine structural equivalences rather than introducing noise. A systematic underestimation of far-red absorption maxima, where the model saturates near 610 nm, represents the primary limitation and is addressed in the Discussion.


The validated model was applied to 47,700 opsin sequences assembled from NCBI to produce the Opsin Atlas, spanning 20,061 type I opsins across 8 families and 27,639 type II opsins across 10 families (12 subfamilies).


**Type I opsins** (Figure 4.6A). Predictions of λmax^AT for native all-trans retinal show a mean of 519.5 ± 28.1 nm (range: 436–644 nm) across 20,061 sequences. The aggregate distribution approximates a single Gaussian centered near 520 nm, reflecting the relatively homogeneous spectral tuning of microbial rhodopsins around their shared proton-pumping or sensory functions. Within this envelope, individual subfamilies occupy characteristic spectral ranges: proton pump: 532.4 ± 23.8 nm (n=5,108, 25.5%), heliorhodopsin: 498.5 ± 37.6 nm (n=4,993, 24.9%), green-absorbing proteorhodopsin: 520.7 ± 16.3 nm (n=4,942, 24.6%), xanthorhodopsin: 527.3 ± 12.5 nm (n=4,304, 21.5%), blue-absorbing proteorhodopsin: 537.0 ± 20.7 nm (n=310, 1.5%), cation channel: 486.1 ± 25.6 nm (n=120, 0.6%), chloride pump: 525.6 ± 16.1 nm (n=103, 0.5%), sensory rhodopsin II: 508.5 ± 25.3 nm (n=89, 0.4%), sensory rhodopsin I: 509.0 ± 24.5 nm (n=86, 0.4%), and anion channel: 478.3 ± 15.7 nm (n=6, <0.1%). Four subfamilies—proton pumps, heliorhodopsins, green-absorbing proteorhodopsins, and xanthorhodopsins—together account for 96.5% of all type I sequences. Proteorhodopsins show a characteristic bimodal distribution, with distinct blue-absorbing and green-absorbing sub-populations reflecting ecological adaptation to different ocean depths. Heliorhodopsins span the widest spectral range but are blue-shifted relative to the classical proton pumps.


Type II opsins (Figure 4.6B). In contrast to the unimodal type I distribution, the 11-cis dark-state predictions for 27,639 type II opsins (mean 467.0 ± 42.9 nm, range 344–583 nm) resolve into multiple distinct peaks corresponding to the spectral classes of animal vision. Per-subfamily statistics are: rod opsin: 481.7 ± 24.0 nm (n=5,321, 19.3%), neuropsin: 459.8 ± 36.7 nm (n=4,731, 17.1%), encephalopsin: 465.7 ± 21.5 nm (n=4,317, 15.6%), cone SWS1: 413.0 ± 42.3 nm (n=3,237, 11.7%), melanopsin: 495.2 ± 24.6 nm (n=2,584, 9.3%), cone MWS: 532.4 ± 31.3 nm (n=2,473, 8.9%), RGR: 456.0 ± 25.3 nm (n=2,041, 7.4%), peropsin: 448.3 ± 20.5 nm (n=1,449, 5.2%), parapinopsin: 430.1 ± 33.6 nm (n=1,255, 4.5%), VA opsin: 436.6 ± 32.4 nm (n=102, 0.4%), cone LWS: 486.8 ± 26.3 nm (n=64, 0.2%), and pinopsin: 453.1 ± 34.2 nm (n=64, 0.2%). The dominant peak near 500 nm is formed by rod opsins, the primary dim-light photoreceptors. A second major cluster in the UV-blue range below 430 nm comprises cone SWS1 opsins and parapinopsin, which detect short wavelengths for color discrimination and circadian entrainment. Cone MWS opsins form a distinct peak near 530 nm, while melanopsin clusters near 495 nm. Non-visual opsins—encephalopsin and neuropsin—populate the intermediate blue-green range. This multimodal structure reflects the evolutionary diversification of animal opsins into specialized spectral channels for color vision, scotopic sensitivity, and non-visual photoreception.


LAMBDA also predicts λmax^AT for all type II opsins—the absorption maximum with all-trans retinal, as occurs during photoactivation or stably in bistable opsins. The λmax^AT distribution is systematically red-shifted relative to 11-cis predictions and collapses from the multimodal 11-cis pattern into a bimodal shape: a primary peak near 520 nm dominated by rod and long-wavelength cone opsins, and a secondary shoulder near 490 nm comprising SWS1, neuropsin, RGR, and encephalopsin. This dual-state analysis applies only to type II opsins; the model produces 11-cis predictions for type I sequences, but these lack biological basis and training signal and are omitted from the atlas.


For type II opsins, predictions for both chromophore states enable estimation of the spectral shift upon activation. Δλ is computed using the protonated Schiff base predictions only (λmax > 400 nm), excluding UV-absorbing deprotonated states—the goal is to isolate the spectral shift arising from binding pocket interactions with retinal, not the large blue shift that accompanies Schiff base deprotonation (which moves any opsin into the UV regardless of pocket composition). These Δλ values are derived quantities: the all-trans prediction for type II opsins is trained on only 31 dual-state sequences and has not been independently validated, so the spectral shift estimates should be interpreted as indicative rather than quantitative. The signed difference Δλ = λmax^AT − λmax^11-cis ranges from −108 to +148 nm (mean +18.8 ± 33.0 nm; Figure 4.6C), with 23% of predictions showing a blue shift (negative Δλ). Per-subfamily means reveal consistent differences: VA opsin (+47.5 ± 28.4 nm), cone SWS1 (+41.7 ± 30.7 nm), RGR (+34.5 ± 22.1 nm), and peropsin (+24.8 ± 18.6 nm) show the largest red shifts. Rod opsin (+17.7 ± 20.0 nm), neuropsin (+17.5 ± 28.7 nm), and cone LWS (+5.2 ± 15.8 nm) show modest shifts. Cone MWS is the only subfamily with a negative mean (−37.9 ± 29.9 nm), indicating that these opsins are predicted to blue-shift upon isomerization to all-trans. Melanopsin (+21.6 ± 43.4 nm) shows the widest spread, spanning both directions.


The atlas is available as a supplementary resource, providing predicted λmax values for both chromophore states, spectral separation estimates, GRN annotations, and taxonomic metadata for each sequence.


Discussion


LAMBDA demonstrates that binding domain analysis—representing the chromophore environment as a graph aligned on retinal—enables spectral prediction across protein families from a single model. Where OPTICS and the Inoue model extract features from amino acid sequences, and RhoMax uses structure-derived graphs limited to type I opsins, LAMBDA defines graph nodes by their spatial relationship to the chromophore rather than by sequence position. GRN systems make this a structure-based model that accepts sequence as input.


Accuracy comparable to the best family-specific methods (5.18 nm MAE for type II, 6.86 nm for type I) is achieved while simultaneously predicting multiple chromophore states from a unified model—a capability that sequence-based approaches, which are inherently fold- and conformation-specific, cannot provide. The improvement over OPTICS' sequence-based approach (5.49 nm cross-validated) suggests that binding pocket structure provides more robust features than lineage-specific sequence patterns. Within this representation, pLM embeddings (Ankh-large, 1536 dimensions) describe what occupies each binding pocket position while the graph describes where those positions are relative to retinal—the model depends on both, but the graph structure is what enables cross-family learning.


The most informative limitation is LAMBDA's systematic underestimation of far-red absorption maxima. The model saturates at approximately 610 nm, compressing the 590–650 nm range even when these samples are included in training. This reflects physics rather than architecture: the relationship E = hc/λ means that energy gaps shrink dramatically at long wavelengths, and at these small scales spectral tuning becomes dominated by subtle local effects the model can not detect—precise positioning of partial charges, fine details of hydrogen bonding, electronic polarization—that produce disproportionately large wavelength shifts. The binding pocket graph captures residue identity and spatial arrangement, but not the electrostatic precision required to resolve 0.03 eV differences in excitation energy. I mentioned this thought about LAMBDA’s and current machine learning approaches’ limitation in general to the author of the type I opsin dataset, Dr. Keiichi Inoue. We agreed that additional training data are unlikely to help; the features that distinguish a 600 nm opsin from a 640 nm opsin may require explicit quantum mechanical modeling. For optogenetic engineering, LAMBDA can identify candidates as deeply red-shifted but cannot rank them within that regime—precise spectral positioning above 590 nm requires either experimental characterization or hybrid approaches combining machine learning with QM/MM refinement. 


More generally, the model cannot generalize to novel protein folds without training examples—the relationship between residue positions and spectral effects is fold-specific and must be learned. Predicting properties beyond λmax—quantum yield, photocycle kinetics, ion selectivity—would require expanded training data and potentially modified architectures, and the model does not account for post-translational modifications or lipid environment effects that may influence spectral properties in vivo.


Despite these limitations, the atlas enables computational screening across the full spectral range—identifying red-shifted opsins for tissue penetration, spectrally separated pairs for multiplexed control, and opsins with large dark-to-activated spectral separation for bidirectional tools. LAMBDA is the first method to predict the spectral separation between dark and activated states systematically. Across type II opsins, most subfamilies red-shift upon activation, but cone MWS opsins are predicted to blue-shift (mean −37.9 nm)—the only subfamily with a negative mean. This pattern reflects a convergence: all-trans predictions cluster near 520 nm regardless of subfamily, while 11-cis dark-state tuning is subfamily-specific. Opsins absorbing at short wavelengths in the dark state accumulate large positive Δλ because the all-trans state is red-shifted relative to their blue dark state; cone MWS opsins, already at ~530 nm, shift in the opposite direction. Cone LWS opsins, at the longest wavelengths, show minimal shift—selective pressure acts on the 11-cis dark state for wavelength discrimination, not on the activated conformation.


Among subfamilies with the largest positive Δλ, VA opsin, melanopsin, and RGR are known bistable photopigments or photoisomerases; their larger predicted separations could indicate that maintaining spectrally distinct states is linked to bistable signaling. Rod opsins show modest shifts, consistent with their rapid meta-II decay. These correspondences are suggestive but not conclusive—Δλ is a derived quantity, not a training target, so if these trends hold under experimental scrutiny they would provide indirect validation that the model captures biologically meaningful spectral tuning. The atlas highlights specific candidates for optogenetic applications: a heliorhodopsin from Candidatus Kerfeldbacteria (PIS41810) is predicted as the most red-shifted type I opsin at 644 nm, deep into the optical window for tissue penetration; an SWS1 opsin from Hylia prasina (NWU40863) as the most blue-shifted type II opsin at 344 nm; and for bidirectional control, a peropsin from the beluga whale Delphinapterus leucas (XP_022422838) shows the largest predicted spectral separation at +148 nm (458 nm dark state, 607 nm activated), followed by melanopsins from Sturnira hondurensis (+146 nm) and Phyllostomus discolor (+143 nm). The ability to predict how mutations affect both chromophore states enables engineering strategies that optimize spectral separation, not just dark-state absorption—candidates that would be impractical to discover through experimental screening alone.


Beyond opsin families, the hCRBPII results demonstrate that LAMBDA's framework extends to entirely different protein folds. Despite the fundamentally different lipocalin architecture, the model achieves accuracy comparable to opsin predictions when training examples are available - though with n=6 samples in the test split this result is statistically weak. The boundary is principled: extending to a new fold requires defining its binding pocket graph and providing representative training data, rather than building a separate model. 


An open limitation is the role of solvent in spectral tuning. In opsins, the binding pocket is largely occluded from bulk water, and the model may implicitly learn solvation effects through correlations with surrounding residue identities. In solvent-exposed binding pockets, water molecules directly contact the chromophore and modulate its absorption in ways that depend on occupancy and orientation rather than protein sequence. pLM embeddings may capture some of this context—residues flanking a solvent-exposed pocket differ systematically from those in a buried one—but are unlikely to fully resolve the spectral effects of specific water configurations. For proteins with open binding sites, this remains a source of prediction error that neither additional sequence data nor larger embeddings are likely to eliminate without explicit solvation modeling.


When structures are available, binding pocket graphs can be derived directly. For the sequence-only path—which enables the Opsin Atlas and any large-scale application—LAMBDA depends on the standardized positional annotation developed in the preceding chapter: without MOGRN coordinates for microbial rhodopsins, the graph representation that enables cross-family learning from sequence would not exist; without the chromophore-centered mapping between MOGRN and Ballesteros-Weinstein positions, type I and type II opsins could not share graph nodes. This dependency is also the source of extensibility—any protein family with a retinal-binding pocket and an appropriate GRN system can be incorporated. The binding pocket representation further enables spectral prediction for engineered proteins that preserve the chromophore environment while modifying other regions. The following chapter explores this through rhodozyme design—engineering the intracellular regions of type II opsins to incorporate enzymatic active sites that become accessible only upon light activation, with spectral properties that remain predictable because the binding domain is preserved.


Rhodozyme — Light-Activated Enzyme Design


This chapter, on the application of ProtOS, is meant as a showcase of its capabilities - the protein design process we demonstrate here is computational and analytically sound. Experimentally feasible? I will answer that at the end. The validation remains outside the scope of my own work.


Type II opsins undergo a conformational change upon photon absorption. In the dark state, the seven transmembrane helices pack tightly, with the intracellular face closed. Photoisomerization of retinal triggers a cascade of sidechain rearrangements at conserved positions—the microswitch residues—that propagate the conformational change from the binding pocket to the intracellular surface. These microswitches are well characterized: they include residues on TM3, TM5, TM6, and TM7 whose rotameric states differ between the inactive and active conformations. The net effect is that TM6 moves 10–14 Å outward at its cytoplasmic end, exposing a cavity that in native rhodopsin binds the G protein transducin. This cavity is transient, stereochemically defined, and gated by light. The retinal binding pocket—buried in the transmembrane core—determines the absorption wavelength, while the intracellular cavity is a separate surface. If an enzymatic active site could be placed on this intracellular face, the result would be a light-gated enzyme whose activation wavelength is set by the rhodopsin scaffold.


This chapter explores whether such a design can be assembled computationally. The core technique—scaffolding a protein backbone around a fixed arrangement of catalytic residues (a theozyme)—was established by the Baker lab in RFdiffusion2 (Ahern et al., 2025). Their protocol generates 100 backbone designs per theozyme, fits 8 sequences per design with LigandMPNN, validates all candidates with structure prediction, and picks the best by predicted confidence. We follow the same protocol. The rhodozyme application adds an earlier step and an additional difficulty: the scaffold is not a novel fold but an existing rhodopsin in its active conformation, and the mask that separates fixed from designable regions must preserve both the retinal binding pocket (for light sensitivity) and the theozyme positions (for catalysis). This means candidate selection happens at two stages rather than one—first at theozyme placement (is the geometry compatible with the rhodopsin intracellular face?) and again at validation (does the predicted structure maintain both the rhodopsin fold and the catalytic geometry?). This is where ProtOS contributes. The models are difficult; the data integration between them is not, provided the intermediate representations—structures, annotations, graphs, masks—are managed consistently. ProtOS handles structure loading, GRN annotation, geometric matching, mask construction, and job dispatch to the Model Manager. The theozyme extraction and placement code (Steps 2–3) required only a small, application-specific addition outside ProtOS's general processor framework.


The design proceeds in six steps. Each step can produce multiple outputs that fan out into the next: the geometric search yielded 8 candidate placements, of which we selected 2 based on geometric quality and helix involvement; for each we generated 50 backbone designs with RFdiffusion, sampled 8 sequences per design with LigandMPNN, and predicted all resulting candidates with Boltz2. For placement 00, this produced 50 backbone designs, 405 sequences (from 45 successful designs), and 307 Boltz2 structure predictions.


Step 1 — Starting Structures


Three structures are required. The first is a rhodopsin in its active conformation—metarhodopsin II (PDB: 3PQR), which captures the open intracellular state with TM6 displaced outward. The dark-state structure of the same protein (PDB: 1U19, bovine rhodopsin at 2.2 Å) serves as a reference for the conformational change: superimposing the two reveals the TM5/TM6 displacement that creates the intracellular cavity. The second is a reference enzyme bound to its substrate in a catalytic intermediate. We use bovine trypsin (PDB: 2AGE), an acyl-enzyme intermediate at 1.15 Å resolution with succinyl-AAPR covalently bound to the catalytic serine. This structure captures the triad geometry mid-catalysis—Ser195, His57, and Asp102 in their active arrangement, with the substrate positioned at the reaction center. The enzyme provides the catalytic geometry to be transplanted; the rhodopsin provides the scaffold that gates access to it.


> **Figure 5.1** — Input structures and the design premise. (A) Dark-state bovine rhodopsin (1U19, gray) superimposed with active-state metarhodopsin II (3PQR, terracotta), showing TM5/TM6 displacement and the intracellular cavity that opens upon activation. Retinal in rust. (B) Bovine trypsin acyl-enzyme intermediate (2AGE) with the catalytic triad as sticks (Ser195, His57, Asp102) and hydrogen-bond distances shown as dashed lines. Covalently bound substrate (succinyl-AAPR) in ochre.


Step 2 — Theozyme Extraction


The theozyme is the minimal catalytic unit: the three sidechain positions that perform chemistry. For a serine protease, these are the nucleophilic serine, the general base histidine, and the orienting aspartate. From the trypsin structure, we extract three quantities per residue: the Cα coordinate, the Cα→Cβ vector (sidechain direction), and the residue identity. The pairwise Cα–Cα distances define a triangle; the Cβ vectors define the orientation of each sidechain within that triangle. Together, these six quantities (three positions, three directions) specify the catalytic geometry that must be reproduced in the rhodopsin scaffold.


The catalytic triad in 2AGE shows the characteristic hydrogen-bond relay: the Ser195 hydroxyl is 3.04 Å from His57 Nε2, and His57 Nδ1 is 2.75 Å from Asp102 Oδ2. These functional-atom distances define the active geometry. The Cα triangle that supports this arrangement has sides of 8.3 Å (Ser195–His57), 6.5 Å (His57–Asp102), and 10.1 Å (Ser195–Asp102).


> **Figure 5.2** — Theozyme extraction. The catalytic triad shown in the trypsin active site (gray cartoon) with the geometric abstraction overlaid: Cα positions as spheres, Cα→Cβ direction vectors as arrows, pairwise distances as dashed lines. Distances: Ser195–His57 = 8.3 Å, His57–Asp102 = 6.5 Å, Ser195–Asp102 = 10.1 Å. This triangle and these vectors are the input to the placement search—everything else about trypsin is discarded.


Step 3 — Theozyme Placement


The intracellular face of active rhodopsin is identified using GRN annotation. Residues on TM helix ends that face the cytoplasm (TM1 ≥ 1.60, TM3 ≥ 3.55, TM5 ≥ 5.68, TM7 ≥ 7.53) and intracellular loop residues (ICL1, ICL2, ICL3, H8) form the candidate region. An exhaustive search over all triplets in this region finds positions whose Cα triangle matches the theozyme triangle within 2 Å RMSD. Candidates passing the distance filter are then tested for sidechain direction: the source Cα triangle is Kabsch-aligned onto the candidate, and the rotated Cβ vectors are compared. Matches within 30° are retained.


An additional constraint requires at least one residue on TM5 or TM6—the helices that move during activation. This ensures that the catalytic geometry depends on the active conformation: in the dark state, with TM6 packed inward, the triad distances break. The enzyme turns on with light and off without it.


This step has no equivalent in the Baker lab protocol. Ahern et al. (2025) start from a theozyme and generate a novel scaffold around it; the placement is implicit in the diffusion process. Here, the scaffold is fixed—we must find positions in an existing structure that can accommodate the catalytic geometry. The search produced 8 candidates. We selected placements 0 and 2 based on triangle RMSD, Cβ vector alignment, and the involvement of TM6 residues. For placement 00, the theozyme maps to Ser-230, His-245, and Asp-250 on the intracellular face of 3PQR. The placement reproduces the trypsin Cα triangle exactly (8.3 / 6.5 / 10.1 Å) and preserves the hydrogen-bond distances (Ser–His 3.04 Å, His–Asp 2.75 Å).


> **Figure 5.3** — Theozyme placement on the rhodopsin scaffold. (A) The placement structure (3PQR with theozyme mutations) viewed from the intracellular face. TM helices in gray, theozyme residues (Ser-230, His-245, Asp-250) shown as sticks with Cα spheres in green. Retinal in rust. (B) Same structure from an alternate angle showing the theozyme sidechain arrangement relative to the transmembrane core.


Step 4 — Backbone Design with RFdiffusion


Point mutations at the matched positions would introduce the correct residues but not the correct backbone geometry. The surrounding loops and helix termini must accommodate the theozyme. RFdiffusion generates backbone designs under constraints.


The mask defines what is fixed and what is designed. The locked regions comprise the TM helices (TM1–TM2, TM3, TM4–TM5, TM6–TM7), preserving the transmembrane core, the retinal binding pocket, and the microswitch residues that mediate the activation mechanism—210 residues in total. The three theozyme positions (Ser-230, His-245, Asp-250) are locked with their sidechain atoms explicitly constrained. Between these locked segments, 116 residues are free for RFdiffusion to redesign—these correspond to the intracellular loops (ICL1–3), the theozyme-surrounding loops, and the C-terminal region. Retinal and the tetrapeptide substrate are included as ligand context.


We generate 50 designs per placement. The smaller number (vs. 100 in Ahern et al.) reflects the additional constraint: the locked TM scaffold reduces the conformational search space relative to unconstrained scaffolding, but also makes each design harder to solve.


> **Figure 5.4** — RFdiffusion mask. The mask applied to the rhodopsin scaffold: TM helices and theozyme positions locked (gray), intracellular loops free for design (terracotta). Theozyme residues marked as green spheres. Retinal (rust) sits in the locked transmembrane core, unchanged by design. 210 residues are locked; 116 are designed.


Step 5 — Sequence Design with LigandMPNN


Each RFdiffusion backbone specifies a fold but not a sequence. LigandMPNN generates amino acid sequences compatible with the designed backbone while accounting for the retinal cofactor and the substrate ligand. The theozyme residues (Ser, His, Asp at the fixed positions) are provided as constraints—LigandMPNN designs the rest.


Following Ahern et al. (2025), 8 sequences are sampled per backbone at temperature T=0.1. The retinal SMILES and substrate SMILES are included in the LigandMPNN input so that the designed sequence accounts for both the cofactor that enables light activation and the substrate that the enzyme should bind. For placement 00, this produced 405 sequences across 45 successful backbone designs. The top candidate has 72.7% sequence identity to wild-type rhodopsin (3PQR), with 89 mutations concentrated in the redesigned loop regions. The locked TM helices retain the native sequence almost entirely.


> **Figure 5.5** — Sequence design. Sequence alignment of the top candidate against wild-type rhodopsin (3PQR). Identical positions in gray, mutations highlighted. Mutations cluster in the redesigned loop regions; the TM helices are largely unchanged. Theozyme positions (Ser-230, His-245, Asp-250) marked.


Step 6 — Structure Prediction with Boltz2


Each designed sequence is predicted with Boltz2 to evaluate whether the intended fold and catalytic geometry are maintained. The prediction includes the protein chain, retinal (as covalent cofactor), and substrate. This is the second filtering stage. Ahern et al. (2025) rank candidates by predicted confidence; we evaluate on two criteria specific to the rhodozyme constraint.


The first criterion is theozyme alignment. We superimpose each predicted structure onto the placement from Step 3, aligning only the three theozyme residues (all atoms, not just Cα), and measure the RMSD. This tests whether the catalytic geometry survived the design-predict cycle. Across all 307 predictions, we rank candidates by this theozyme all-atom RMSD. The second criterion is pLDDT of the Boltz2 prediction, reported per-residue. We examine pLDDT separately for the locked regions (which should score high, as they reproduce known structure) and the designed regions (where low confidence indicates the model is uncertain about the backbone).


The comparison between predicted and reference theozyme geometry requires more than a rigid-body superposition. The Cα positions may align well while the sidechain rotamers differ—a common outcome when Boltz2 resolves the local environment differently from the reference. We therefore allow sidechain rotation around the Cα–Cβ bond axis when assessing the match, comparing the functional-atom distances (Ser OG – His Nε2, His Nδ1 – Asp Oδ) rather than insisting on identical χ1 angles. 


An unexpected observation emerged from inspecting the validated designs. Because the theozyme was placed flatly on the ICL3 surface, the designed loops could fold in two ways: with the substrate-binding face directed inward (into the helical bundle interior, as originally intended) or outward (toward the cytosolic side of ICL3). The top-ranking prediction adopted the outward orientation—the catalytic face and substrate-binding site point toward the cytoplasm rather than into the transmembrane pocket. The theozyme geometry itself is preserved in both orientations; what differs is where the substrate approaches. The outward orientation may be more favorable, since substrate access is not occluded by the surrounding helices. Crucially, the light-gating mechanism is unaffected: the triad residues sit on positions that are only in register when TM5/TM6 adopt the active conformation, regardless of which face the binding site presents.


We selected the top candidate by balancing theozyme RMSD (2.44 Å all-atom, 0.51 Å Cα-only, rank 6 of 307) against the highest global pLDDT in the top 10 (91.7). The overall backbone RMSD to the parent rhodopsin is 0.84 Å, confirming that the fold is preserved. The pLDDT breakdown shows high confidence in the locked TM core (94.9 mean) and good confidence in the designed loops (85.6 mean), with the theozyme residues at 72.1—lower, as expected for residues at a designed interface.


The catalytic geometry in the predicted structure shows the Ser–His distance at 4.03 Å and the His–Asp distance at 3.18 Å, compared to 3.04 Å and 2.75 Å in the reference placement. These distances are longer than the ideal hydrogen-bond geometry but within the range that could be optimized by further design iterations or molecular dynamics relaxation.


Because the retinal binding pocket is preserved by the mask, the Schiff base linkage to Lys-296 is intact in the predicted structure. LAMBDA can predict the spectral properties of retained candidates—the rhodozyme absorbs at the same wavelength as the parent rhodopsin.


> **Figure 5.6** — Boltz2 evaluation of the top candidate. (A) Predicted structure overlaid on the parent rhodopsin. Gray: reference TM core (locked regions from 3PQR). Terracotta: designed loop regions (Boltz2 prediction). Retinal and Schiff base Lys-296 in rust. Overall backbone RMSD: 0.84 Å. (B) Catalytic geometry comparison: predicted theozyme (green) overlaid on reference placement (gray), with catalytic interaction distances shown. Reference: Ser–His 3.04 Å, His–Asp 2.75 Å. Predicted: Ser–His 4.03 Å, His–Asp 3.18 Å. (C) Per-residue pLDDT confidence. Locked TM core: 94.9 mean. Designed loops: 85.6 mean. Theozyme residues: 72.1 mean. Global: 91.7.


We consider the computational design a success: Boltz2 predicts a well-folded structure (pLDDT 91.7) that preserves the rhodopsin fold (backbone RMSD 0.84 Å) and maintains the theozyme geometry within optimizable range. The most difficult step in the workflow is not the AI-driven design or validation, but the original theozyme placement. This is a combinatorial and structural biology problem that precedes the Baker lab protocol entirely. Each placement generates a full cascade of 50 backbone designs × 8 sequences × structure predictions—for two placements, this already produces over 600 candidates to evaluate. Selecting many placements without careful geometric and structural reasoning would produce a vast screening space that is computationally expensive and difficult to interpret. The placement decision requires intuition about protein geometry, knowledge of the rhodopsin conformational cycle, and judgment about which helix positions can support catalytic function. The same kind of expert judgment applies at the end of the pipeline: interpreting predicted structures, assessing whether catalytic distances are close enough, and deciding which candidates merit experimental follow-up. The AI models automate the generative steps; the structural biology reasoning that frames and interprets them remains human.


Integration


Every step in this workflow—structure fetching, annotation, geometric matching, mask construction, model submission, and result registration—runs through ProtOS. The PDB structures are fetched and loaded by the StructureProcessor. GRN annotation identifies the intracellular face. The theozyme placement search operates on the annotated coordinates. The mask for RFdiffusion is built from GRN regions and theozyme positions. RFdiffusion, LigandMPNN, and Boltz2 jobs are submitted and tracked by the Model Manager, which registers each output—backbone PDB, FASTA sequence, predicted CIF—as an entity in ProtOS. The evaluation scripts query these entities to compute theozyme RMSD and pLDDT statistics across all candidates.


RFdiffusion2, LigandMPNN, and Boltz2 are published tools; the Baker lab's protocol for combining them is established. ProtOS reproduces that protocol within a managed data framework, applied to a different and more constrained problem. Three AI models, each with its own input format and output format, are integrated into a single pipeline where intermediate results are traceable and the full provenance from PDB entry to predicted structure is recorded. When a candidate fails at validation, we can trace back to its placement, its backbone, its sequence, and ask why.


No experimental validation of the rhodozyme concept exists at this time. Protein design is not an exact science—it requires generating large numbers of candidates, screening them computationally, and selecting the most promising for synthesis and assay. The designs shown here are ongoing work. The contribution of this chapter is not a validated enzyme but a demonstration of what ProtOS can do: integrate multiple structure-generation models into a single pipeline with consistent data management, enabling the large screens from which candidates emerge. We show one such candidate. The rhodozyme concept itself remains speculative; the ability to explore it at scale, using the Baker lab's protocol within a managed data framework, is what this chapter highlights.


The rhodopsin scaffold offers one further possibility. Because the retinal binding pocket is separate from the intracellular catalytic face, different rhodopsins—with different absorption maxima—could carry different enzymes. In principle, a trypsin-rhodozyme built on a 500 nm rhodopsin would absorb at 500 nm; a papain-rhodozyme on a 550 nm scaffold would absorb at 550 nm. Different wavelengths could activate different enzymes, and sequential catalytic steps on the same substrate could become addressable by color. This is the domain of LAMBDA, the spectral tuning model described in the next chapter.




ProtOS-MCP - Talk to your proteins




The preceding chapter designed a rhodozyme — a light-controlled enzyme — using ProtOS as a Python framework. The workflow spanned multiple processors: structures were loaded and manipulated, sequences extracted and annotated, binding pocket graphs constructed, spectral properties predicted, and candidate designs ranked. Every step required writing code. The experimentalist who conceived the rhodozyme concept — who understands opsin activation, catalytic triad geometry, and spectral tuning — could not run this pipeline without a programmer.


This chapter removes that requirement. ProtOS-MCP exposes the same processors through natural language: a researcher describes what they want, and the system executes it. The contribution is not the natural language interface itself — large language models that call tools are not new — but the domain-specific infrastructure behind the interface. Without ProtOS managing entities, paths, datasets, and processor operations, the language model would have nothing to call. Without the language model, ProtOS remains inaccessible to non-programmers. The combination creates something neither component provides alone: conversational structural biology.


The following sections introduce the architecture briefly, then demonstrate it on the same rhodozyme from Chapter 5.


The Model Context Protocol


A language model generates text. It does not load structures, align sequences, or predict absorption spectra. To perform these operations, it needs tools — structured interfaces that accept parameters and return results. When a researcher asks "predict the absorption of this opsin," the model recognizes the intent, selects the appropriate tool, populates its parameters, and interprets the result.


The Model Context Protocol (MCP) standardizes how language models discover and invoke such tools. Developed by Anthropic, MCP defines a server that exposes available tools with typed schemas, accepts structured calls from the model, executes them, and returns structured results. The model never accesses files, databases, or compute resources directly. It operates entirely through the tool interface.


ProtOS-MCP implements this protocol. Each ProtOS processor exposes its operations as MCP tools: the Sequence Processor provides tools for loading, aligning, and mutating sequences; the Structure Processor for loading and analyzing structures; the GRN Processor for annotating and querying generic residue numbers; the Embedding Processor for generating per-residue representations; the Property Processor for storing and querying results; and the Model Manager for running LAMBDA predictions. In total, ProtOS-MCP exposes over 120 tools organized by processor category. The complete tool catalog is provided in the Supplementary Materials.


Figure 6.1 shows the architecture. The researcher types a question in natural language. The language model interprets it and issues one or more MCP tool calls to the local ProtOS server. The server executes each call against the ProtOS installation and returns structured JSON. The model synthesizes the results into a natural language response. Critically, ProtOS-MCP runs locally. No protein data leaves the researcher's machine — only the conversational text passes through external servers. Structures, sequences, embeddings, and predictions remain on local storage throughout.


The language model maintains conversational context and decides which tools to call next. This means the model performs the workflow orchestration that a Python script would otherwise encode — deciding what to load, what to compare, and in what order.
Redshifting the Rhodozyme


To demonstrate ProtOS-MCP, the same rhodozyme from Chapter 5 is used as a starting point. The design preserves the retinal-binding domain, which means spectral tuning remains possible: mutations in the chromophore environment can shift the absorption wavelength without disrupting the designed catalytic site. The question posed through conversation: can the rhodozyme's predicted absorption be shifted toward longer wavelengths by transplanting binding pocket residues from the human long-wave sensitive opsin?


Figure 6.2 shows the complete conversation. It proceeded in four turns, involving 20 tool calls across five processors. No code was written.


**Turn 1 — Orientation.** The researcher asks the system to review its capabilities. The model queries the ProtOS guide and returns a structured summary of all processor modules. This reflects how a researcher would naturally begin: understanding what tools are available before deciding what to do (Figure 6.2a).


**Turn 2 — Data ingestion.** The researcher provides a FASTA file containing the rhodozyme sequence. The model scans the input directory, registers the file as a sequence entity, and confirms it is now tracked in ProtOS (Figure 6.2b).


**Turn 3 — Spectral prediction.** The researcher asks to run LAMBDA. Before executing, the model reviews how the pipeline works and inspects the sequence. It correctly identifies the rhodozyme as a type II opsin from its N-terminal motif, selects the appropriate protein family parameters, and runs the prediction. The pipeline completes automatically — GRN assignment, embedding generation, and spectral prediction in a single call. The predicted absorption: 496 nm for 11-*cis* retinal, consistent with the rhodopsin family (Figure 6.2c).


**Turn 4 — Rational redshift engineering.** The researcher poses a complex challenge: compare the rhodozyme's binding pocket to the human long-wave opsin at GRN positions, create single-point mutants at divergent sites, screen them with LAMBDA, then perform a greedy cumulative walk to find the combination that maximizes redshift. The model decomposes this into five discrete steps — locating the reference sequence, annotating both with GRN, comparing binding pockets, screening 20 single mutants, and running the cumulative walk — executing 11 tool calls without further prompting. It identifies 20 divergent pocket positions, screens each substitution individually, then builds cumulative variants in order of predicted redshift. The walk peaks at seven mutations with a predicted shift from 496 to 514 nm before additional mutations erode the effect. The optimal variant is exported as FASTA (Figure 6.2d).
Discussion


The value of this demonstration is not the resulting design — which, like all computational designs in this thesis, awaits experimental validation. The value is what the interaction reveals about the system's capabilities as a research tool.


The conversation compressed a multi-step protein engineering analysis into four natural language exchanges. A researcher who cannot write Python posed a question that required sequence registration, GRN annotation across two proteins, binding pocket comparison using Ballesteros-Weinstein numbering, combinatorial mutant library creation, LAMBDA screening of 42 variants, and result export. The system handled each step, selecting appropriate tools and parameters throughout. A Python script encoding this workflow would require knowledge of the ProtOS API, processor initialization, dataset management, and GRN query syntax. The natural language request required none of this.


The model also applied domain knowledge that was not programmed into the MCP tools. It identified the protein family from the sequence, selected GPCR-specific numbering conventions, and interpreted the predicted absorption in the context of known opsin spectral ranges. This biological reasoning emerged from the language model's training, not from ProtOS — but it only became useful because ProtOS provided the tools to act on it.


The limitations are straightforward. The workflow depends on the language model reasoning correctly about tool selection and parameter values. For the complex fourth turn, the model chained 11 tool calls with dependencies — GRN annotation had to complete before pocket positions could be queried, which had to complete before mutants could be designed. A model that misunderstands one step propagates errors through the rest. In this session, the reasoning was correct. In others — particularly with less capable models or more ambiguous requests — failures occur. The workflow dataset in the Supplementary Materials provides a benchmark for measuring this reliability.


ProtOS-MCP does not replace programming for all use cases. Analyses requiring custom logic, conditional branching, or operations not exposed as tools still require code. What it does is lower the barrier for the common case: a researcher with a biological question and data that fits the existing processor workflows. For the experimentalist who designed the rhodozyme concept but cannot write Python, the spectral tuning analysis shown here becomes accessible. For the bioinformatician who can write Python but needs a quick exploration, it saves time.


The broader point is that infrastructure and accessibility are complementary. ProtOS without MCP is powerful but restricted to programmers. MCP without ProtOS would expose generic tools that lack the domain-specific data management — entity tracking, GRN annotation, processor-specific operations — that makes complex workflows possible. The combination is a conversational interface that executes real analyses, manages real data, and produces real outputs.[j]


Discussion


The introduction identified three gaps: microbial rhodopsins lacked the standardized positional annotation that enabled systematic GPCR comparison, no method predicted spectral properties across the type I and type II divide, and existing tools did not compose into workflows linking sequences, structures, and functional properties while maintaining consistent identity. Each gap required a different solution. Together, those solutions form a system.




Contributions


LAMBDA is the central contribution. It predicts spectral properties across both opsin superfamilies — the first model to treat color tuning as a problem of binding pocket geometry rather than family-specific sequence features. Trained on 2,054 sequences spanning type I, type II, and the lipocalin fold hCRBPII, LAMBDA achieves 4.08 nm mean absolute error on type II opsins and 6.27 nm on type I. The Opsin Atlas extends these predictions to over 40,000 sequences.


LAMBDA works because of MOGRN. Type I and type II opsins diverged billions of years ago and share no detectable sequence similarity outside the binding pocket. A model that takes raw sequence as input cannot learn from both. MOGRN provides the shared vocabulary: a structure-based numbering system for microbial rhodopsins anchored to the Schiff base lysine, analogous to what Ballesteros-Weinstein provides for GPCRs. With both families mapped to standardized coordinates, LAMBDA can represent any opsin binding pocket as a graph aligned on retinal, regardless of fold.


ProtOS made this feasible at scale. Routing 40,000 sequences through GRN annotation, embedding generation, graph construction, and spectral prediction requires managing data across formats and processors without manual intervention. ProtOS handles this through a processor architecture that links sequences, structures, embeddings, properties, and annotations under persistent entity identity. The Opsin Atlas exists because ProtOS could execute the full pipeline for every sequence in the dataset without custom scripting per step.


ProtOS-MCP completes the stack by removing the programming requirement. The same processors that powered the Opsin Atlas are accessible through natural language. Chapter 6 demonstrated this on the rhodozyme: a multi-step spectral engineering workflow — sequence registration, GRN annotation, binding pocket comparison, mutant library creation, LAMBDA screening — ran through four conversational turns, 20 tool calls, no code written.


The deeper principle is that standardized coordinates enable cross-family learning. This is not specific to opsins. Any protein superfamily where a conserved functional site spans divergent folds could benefit from the same approach: define a coordinate system anchored to the functional site, represent the site as a graph, and train a model across families that would otherwise be treated separately.


Limitations


LAMBDA has not been experimentally validated. The Opsin Atlas contains 40,000 predictions, but predictions are not measurements. Model accuracy was evaluated against published spectral data, not against prospective characterization of novel sequences. Until atlas candidates are tested in the lab, LAMBDA remains a computational screening tool. Additionally, accuracy degrades for deeply red-shifted opsins where training data is sparse — the physics of spectral tuning at long wavelengths remains difficult for any sequence-based approach.


MOGRN depends on a conserved structural anchor: the retinal-binding pocket. Microbial rhodopsins share this feature despite overall sequence identity below 20%. Other protein families may lack such an obvious invariant. The GRN Processor architecture accommodates new numbering systems, but defining them — identifying the right anchor, validating across structures, ensuring coverage of functional diversity — remains manual, expert-driven work.


ProtOS-MCP depends on language model reasoning. For single-tool operations — loading a structure, running a prediction — it works reliably. For complex multi-step workflows, the model must chain tool calls with dependencies: annotations must complete before positions can be queried, which must complete before mutants can be designed. Errors in one step propagate. The workflow dataset in the Supplementary Materials provides a benchmark for measuring reliability, but it does not guarantee it.


More broadly, tools reduce barriers but do not replace judgment. A researcher using ProtOS-MCP can run analyses they could not run before. Interpreting the results still requires understanding the biology.




Future Work


Experimental validation of LAMBDA is the most impactful next step. Characterizing even a small subset of Opsin Atlas candidates — selected for maximal predicted spectral diversity — would test whether the model captures real spectral tuning physics or has learned correlations that do not generalize to uncharacterized sequences. Positive results would transform LAMBDA from a screening tool into a framework for understanding color tuning. Negative results would identify where the model fails and guide retraining.


For optogenetics, the atlas identifies specific design targets: red-shifted opsins for deeper tissue penetration, spectrally separated pairs for multiplexed control, and sequences with large dark-to-activated spectral separation for bistable tools. The rhodozyme concept from Chapter 5 — coupling light activation to enzymatic function — extends this further. Color-tuned rhodozymes, each responding to a different wavelength, would enable sequential catalysis triggered by different colors of light. These remain computational designs, but the infrastructure to iterate on them exists.


ProtOS is positioned to integrate the next generation of protein AI models as they arrive. RFdiffusion2, Boltz, and LigandMPNN are already accessible through the Model Manager. As these models mature and new ones emerge, the processor architecture and MCP interface remain stable — new capabilities become available through conversation without requiring users to learn new APIs.




Conclusion


This thesis started with a question about spectral tuning and ended with infrastructure for asking questions about proteins. The path was not planned. MOGRN was built because LAMBDA needed a shared coordinate system. ProtOS was built because LAMBDA needed to process 40,000 sequences without drowning in glue code. ProtOS-MCP was built because I got tired of writing the same data loading and annotation scripts for every new analysis — and because the same interface that saved me time also makes these tools accessible to experimentalists who have never written code.


The introduction framed three gaps: no standardized positions for microbial rhodopsins, no cross-family spectral prediction, no composable multi-modal protein data management. MOGRN, LAMBDA, and ProtOS address them respectively. The underlying principle — that standardized structural coordinates enable learning across evolutionary divides — is the scientific contribution. The practical contribution is that a researcher can now go from a protein sequence to a spectral prediction through a conversation.


What remains is validation. The Opsin Atlas is a collection of hypotheses. Testing them is the next step — and the most exciting one.
________________


Bibliography
________________






Supplementary


This supplementary chapter provides reference materials supporting the main text. These include the complete ProtOS-MCP tool catalog, workflow benchmark specifications, and technical details that would interrupt the narrative flow of earlier chapters.


ProtOS-MCP Tool Catalog


The following table lists all tools exposed through the ProtOS-MCP interface, organized by functional category. Each tool includes its name, required parameters, and a brief description of its function.


#### Loader Tools


| Tool Name | Parameters | Description |
|-----------|------------|-------------|
| `structure_load` | `pdb_id` | Download and load a structure from PDB or AlphaFold |
| `structure_load_batch` | `pdb_ids`, `dataset_name` | Download multiple structures and optionally create a dataset |
| `structure_load_file` | `file_path` | Load a structure from a local mmCIF or PDB file |
| `sequence_load` | `uniprot_id` | Retrieve a sequence from UniProt |
| `sequence_load_batch` | `uniprot_ids`, `dataset_name` | Retrieve multiple sequences and optionally create a dataset |
| `sequence_load_file` | `file_path` | Load sequences from a local FASTA file |
| `molecule_load_from_ccd` | `ccd_id` | Load a molecule definition from the Chemical Component Dictionary |
| `molecule_load_from_structure` | `structure_id`, `ligand_id` | Extract a ligand from a loaded structure |
| `molecule_load_file` | `file_path` | Load a molecule from a local SDF or MOL2 file |


#### Entity and Dataset Tools


| Tool Name | Parameters | Description |
|-----------|------------|-------------|
| `entity_register` | `entity_id`, `entity_type`, `data` | Register a new entity in the registry |
| `entity_lookup` | `query` | Find an entity by ID, alias, or partial match |
| `entity_list` | `entity_type` | List all registered entities of a given type |
| `entity_get_metadata` | `entity_id` | Retrieve metadata for a registered entity |
| `dataset_create` | `name`, `entity_ids`, `metadata` | Create a new dataset from existing entities |
| `dataset_add` | `dataset_name`, `entity_ids` | Add entities to an existing dataset |
| `dataset_remove` | `dataset_name`, `entity_ids` | Remove entities from a dataset |
| `dataset_list` | `entity_type` | List all datasets of a given type |
| `dataset_get_members` | `dataset_name` | Get all entity IDs in a dataset |


#### Structure Tools


| Tool Name | Parameters | Description |
|-----------|------------|-------------|
| `structure_summarize` | `structure_id` | Summarize structure contents (chains, residues, atoms) |
| `structure_summarize_ligands` | `structure_id`, `min_atoms` | Identify and describe all ligands in a structure |
| `structure_get_chains` | `structure_id` | List all chains with their types and lengths |
| `structure_get_sequence` | `structure_id`, `chain_id` | Extract amino acid sequence from a structure chain |
| `structure_get_metadata` | `structure_id` | Get experimental metadata (resolution, method, date) |
| `structure_filter_chain` | `structure_id`, `chain_ids`, `new_id` | Create a new structure containing only specified chains |
| `structure_filter_residues` | `structure_id`, `start`, `end`, `chain_id` | Extract a residue range from a structure |
| `structure_remove_hetatm` | `structure_id` | Remove all non-protein atoms (ligands, water) |
| `structure_find_contacts` | `structure_id`, `chain_a`, `chain_b`, `distance` | Find residue contacts within a distance threshold |
| `structure_align` | `mobile_id`, `reference_id`, `method`, `selection` | Superimpose one structure onto another |
| `structure_calculate_rmsd` | `structure_id_1`, `structure_id_2`, `selection` | Calculate RMSD between two structures |
| `structure_compute_water_networks` | `structure_ids`, `distance` | Analyze water-mediated interactions |
| `structure_export` | `structure_id`, `format`, `output_path` | Export structure to mmCIF or PDB file |


#### Sequence Tools


| Tool Name | Parameters | Description |
|-----------|------------|-------------|
| `sequence_get` | `sequence_id` | Retrieve a loaded sequence |
| `sequence_extract_from_structure` | `structure_id`, `chain_id` | Extract sequence from a structure chain |
| `sequence_align_pairwise` | `query_id`, `target_id`, `method` | Align two sequences (global or local) |
| `sequence_align_multiple` | `dataset_name`, `method` | Perform multiple sequence alignment |
| `sequence_build_database` | `dataset_name` | Build MMseqs2 database from a sequence dataset |
| `sequence_search` | `query`, `database`, `evalue`, `min_identity` | Search for homologs in a sequence database |
| `sequence_cluster` | `dataset_name`, `identity_threshold` | Cluster sequences by identity |
| `sequence_export` | `sequence_id`, `output_path` | Export sequence to FASTA file |
| `sequence_export_dataset` | `dataset_name`, `output_path` | Export dataset to multi-sequence FASTA |


#### GRN Tools


| Tool Name | Parameters | Description |
|-----------|------------|-------------|
| `grn_load_reference` | `family`, `config_path` | Load a GRN reference system for a protein family |
| `grn_list_references` | - | List all available GRN reference systems |
| `grn_annotate_sequence` | `sequence_id`, `reference` | Annotate a sequence with generic residue numbers |
| `grn_annotate_structure` | `structure_id`, `chain_id`, `reference` | Annotate a structure with generic residue numbers |
| `grn_annotate_dataset` | `dataset_name`, `reference`, `output_table` | Annotate all sequences in a dataset |
| `grn_get_position` | `sequence_id`, `position` | Get the residue at a specific GRN position |
| `grn_get_segment` | `sequence_id`, `start`, `end` | Extract a segment by GRN range |
| `grn_compare_positions` | `position`, `sequence_ids` | Compare residues at a position across sequences |
| `grn_get_annotation_table` | `table_name` | Load a GRN annotation table |


#### Embedding Tools


| Tool Name | Parameters | Description |
|-----------|------------|-------------|
| `embedding_list_models` | - | List available embedding models |
| `embedding_ensure_model` | `model_name` | Ensure an embedding model is available |
| `embedding_compute` | `sequence_ids`, `model_name` | Compute embeddings for sequences |
| `embedding_compute_dataset` | `dataset_name`, `model_name` | Compute embeddings for all sequences in a dataset |
| `embedding_load` | `entity_ids` | Load previously computed embeddings |
| `embedding_similarity` | `entity_id_1`, `entity_id_2` | Calculate cosine similarity between two embeddings |
| `embedding_similarity_matrix` | `dataset_name` | Compute pairwise similarity matrix for a dataset |
| `embedding_reduce_dimensions` | `dataset_name`, `method`, `n_components` | Apply dimensionality reduction (PCA, UMAP, t-SNE) |
| `embedding_cluster` | `dataset_name`, `method`, `n_clusters` | Cluster embeddings |


#### Property Tools


| Tool Name | Parameters | Description |
|-----------|------------|-------------|
| `property_create_table` | `name`, `data` | Create a new property table |
| `property_load_table` | `table_name` | Load an existing property table |
| `property_add_rows` | `table_name`, `data` | Add rows to a property table |
| `property_update` | `table_name`, `entity_id`, `column`, `value` | Update a value in a property table |
| `property_query` | `table_name`, `filters` | Query a property table with filters |
| `property_correlate` | `table_name`, `column_x`, `column_y` | Calculate correlation between columns |
| `property_export` | `table_name`, `output_path` | Export property table to CSV or parquet |


#### Model Tools


| Tool Name | Parameters | Description |
|-----------|------------|-------------|
| `model_list` | - | List available computational models |
| `model_ensure` | `model_name` | Ensure a model is available (download if needed) |
| `model_predict_structure` | `sequence_id`, `model` | Predict structure from sequence |
| `model_embed_sequence` | `sequence_id`, `model` | Generate embedding using specified model |
| `model_predict_properties` | `sequence_id`, `properties` | Predict sequence properties |


### Workflow Benchmark Specifications


The ProtOS-MCP workflow collection is stratified by difficulty based on the number of tools required, the number of processors involved, and the complexity of result interpretation.


#### Difficulty Criteria


| Level | Tools | Processors | Interpretation | Example |
|-------|-------|------------|----------------|---------|
| Beginner | 1-2 | 1 | Minimal | Load structure, list ligands |
| Intermediate | 3-5 | 2-3 | Moderate | Align structures, annotate with GRN |
| Advanced | 5+ | 3+ | Substantial | Multi-stage functional analysis |


#### Benchmark Categories


| Category | Description | Example Questions |
|----------|-------------|-------------------|
| Data Retrieval | Loading and inspecting data | "What chains are in structure 3SN6?" |
| Sequence Analysis | Alignment, search, clustering | "How similar are these two sequences?" |
| Structure Analysis | Alignment, contacts, geometry | "What residues contact the ligand?" |
| Cross-Processor | Combining multiple data types | "Annotate this structure with GRN" |
| Functional Analysis | Property correlation, prediction | "Which positions correlate with function?" |


#### Evaluation Metrics


Each benchmark workflow is evaluated on:


- **Tool Selection**: Did the model choose appropriate tools for the question?
- **Parameter Accuracy**: Were tool parameters correctly specified?
- **Execution Order**: Were tools called in a logical sequence?
- **Result Interpretation**: Did the model correctly interpret and explain results?
- **Biological Accuracy**: Was the final answer scientifically correct?


### Processor Data Storage Conventions


ProtOS organizes data in a standardized directory structure. The following table describes the storage locations for each processor.


| Processor | Base Directory | Subdirectories | File Formats |
|-----------|---------------|----------------|--------------|
| Structure | `structure/` | `mmcif/`, `cache/`, `datasets/` | `.cif`, `.pkl`, `.json` |
| Sequence | `sequence/` | `fasta/entities/`, `fasta/datasets/`, `alignments/`, `databases/` | `.fasta`, `.aln`, `.mmseqs` |
| GRN | `grn/` | `reference/`, `tables/`, `configs/` | `.yaml`, `.parquet` |
| Embedding | `embedding/` | `embeddings/`, `datasets/` | `.npy`, `.h5` |
| Property | `property/` | `tables/`, `datasets/` | `.parquet`, `.csv` |
| Molecule | `molecule/` | `records/`, `datasets/` | `.sdf`, `.mol2`, `.json` |


### Entity Registry Schema


The entity registry maintains consistent identity across all processors. Each entity record contains:


| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Primary identifier (e.g., PDB ID, UniProt accession) |
| `type` | string | Entity type (structure, sequence, molecule, etc.) |
| `aliases` | list | Alternative identifiers and names |
| `created` | datetime | When the entity was first registered |
| `modified` | datetime | When the entity was last modified |
| `source` | string | Origin of the data (PDB, UniProt, local file, etc.) |
| `metadata` | dict | Type-specific metadata (resolution, length, etc.) |
| `datasets` | list | Datasets containing this entity |
| `relations` | dict | Links to related entities (e.g., structure→sequence) |




### Supported External Tools and Services


ProtOS integrates with external tools and services through standardized interfaces:


| Tool | Purpose | Integration Method |
|------|---------|-------------------|
| Gemmi | mmCIF parsing | Python library |
| MMseqs2 | Sequence search and clustering | Command-line wrapper |
| BioPython | Sequence manipulation | Python library |
| ESM-2 | Protein embeddings | Docker container |
| Ankh | Protein embeddings | Docker container |
| Boltz2 | Structure prediction | Docker container |
| AlphaFold | Structure prediction | API / Docker |




________________
Publications


[a]Horrible phrasing
[b]I refer to them as opsins throughout
[c]is this scientifically valid? It is a founding member in terms of investigation, but is not an ancestor..
[d]is there  a better terminology.. similar to archeae, fungi..
[e]I have to simplify this to a single sentence
[f]they are used like that, but maybe a cleaner description is possible
[g]compare to lambda (3 places, all need to use the latest number)
[h]they are linked, but we need this locally for analysis
[i]too table specific
[j]~poor workding